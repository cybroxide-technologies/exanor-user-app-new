import 'package:flutter/material.dart';
import 'package:exanor/components/custom_cached_network_image.dart';
import 'package:exanor/services/analytics_service.dart';
import '../components/profile_header_card_editable.dart';
import '../components/profile_stats_card_editable.dart';
import '../components/profile_analytics_card.dart';
import '../components/edit_profile_card.dart';
import '../components/grow_with_ads_card.dart';
import '../components/social_media_links_card.dart';
import '../components/achievements_list.dart';
import '../components/experience_list.dart';
import '../components/job_vacancies_tab.dart';
// Translation imports
import '../services/enhanced_translation_service.dart';
import '../components/universal_translation_wrapper.dart';
import '../components/translation_widget.dart';

import '../components/works_list.dart';
import 'add_achievement_screen.dart';
import 'add_experience_screen.dart';
import 'add_work_screen.dart';
import 'edit_profile_screen.dart';
import 'edit_professional_profile_screen.dart';
import 'edit_employee_profile_screen.dart';
import 'my_business_profile_onboarding_screen.dart';
import 'chat_screen.dart';
import 'package:shared_preferences/shared_preferences.dart';
import '../services/api_service.dart';
import 'dart:io';
import 'package:path/path.dart' as path;
import 'package:image_picker/image_picker.dart';
import 'package:flutter/services.dart';
import 'package:permission_handler/permission_handler.dart';
import '../models/achievement_model.dart';
// REMOVED SERVICES - Commented out to make app compilable
// import '../services/employee_service.dart';
// import '../services/business_service.dart';
// import '../services/professional_service.dart';
import '../services/interstitial_ads_service.dart';
import '../utils/image_picker_utils.dart';

class UserProfileEditableScreen extends StatefulWidget {
  final String profile;
  final Map<String, dynamic>? userData;

  const UserProfileEditableScreen({
    super.key,
    this.profile = 'employee',
    this.userData,
  });

  @override
  State<UserProfileEditableScreen> createState() =>
      _UserProfileEditableScreenState();
}

class _UserProfileEditableScreenState extends State<UserProfileEditableScreen>
    with TickerProviderStateMixin {
  late TabController _tabController;
  final EnhancedTranslationService _translationService =
      EnhancedTranslationService.instance;
  final AnalyticsService _analytics = AnalyticsService();

  // Employee profile data state
  Map<String, dynamic>? _employeeProfileData;
  bool _isLoadingEmployeeProfile = false;
  String? _employeeProfileError;

  // Professional profile data state
  Map<String, dynamic>? _professionalProfileData;
  bool _isLoadingProfessionalProfile = false;
  String? _professionalProfileError;

  // Professional media data state
  List<Map<String, dynamic>> _professionalMedia = [];
  bool _isLoadingProfessionalMedia = false;
  String? _professionalMediaError;

  // Employee experience data state
  List<Map<String, dynamic>> _employeeExperiences = [];
  bool _isLoadingExperiences = false;
  String? _experiencesError;

  // Employee achievements data state
  List<Map<String, dynamic>> _employeeAchievements = [];
  bool _isLoadingAchievements = false;
  String? _achievementsError;

  // Employee media data state
  List<Map<String, dynamic>> _employeeMedia = [];
  bool _isLoadingMedia = false;
  String? _mediaError;

  // Business media data state
  List<Map<String, dynamic>> _businessMedia = [];
  bool _isLoadingBusinessMedia = false;
  String? _businessMediaError;

  // Professional connections data state
  List<Map<String, dynamic>> _professionalConnections = [];
  bool _isLoadingProfessionalConnections = false;
  String? _professionalConnectionsError;
  Map<String, dynamic>? _connectionsMetadata;

  // Employee job offerings data state
  List<Map<String, dynamic>> _employeeJobOfferings = [];
  bool _isLoadingEmployeeJobOfferings = false;
  String? _employeeJobOfferingsError;
  Map<String, dynamic>? _jobOfferingsMetadata;

  // Business job invites data state
  List<Map<String, dynamic>> _businessJobInvites = [];
  bool _isLoadingBusinessJobInvites = false;
  String? _businessJobInvitesError;
  Map<String, dynamic>? _jobInvitesMetadata;

  // Business job applications data state
  List<Map<String, dynamic>> _businessJobApplications = [];
  bool _isLoadingBusinessJobApplications = false;
  String? _businessJobApplicationsError;
  Map<String, dynamic>? _jobApplicationsMetadata;

  // Employee job applications data state
  List<Map<String, dynamic>> _employeeJobApplications = [];
  bool _isLoadingEmployeeJobApplications = false;
  String? _employeeJobApplicationsError;
  Map<String, dynamic>? _employeeJobApplicationsMetadata;

  void _addAchievement() {
    // Show interstitial ad before navigating to add achievement
    InterstitialAdsService.instance.showAdIfAvailable(
      context: 'add_achievement',
      onCompleted: () {
        Navigator.push(
          context,
          MaterialPageRoute(
            builder: (context) => AddAchievementScreen(
              onAchievementAdded: (Achievement achievement) {
                // Refresh the achievements list after adding a new achievement
                setState(() {
                  // The AchievementsList component will handle refreshing itself
                });
              },
            ),
          ),
        );
      },
    );
  }

  void _addExperience() {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => AddExperienceScreen(
          onExperienceAdded: (experience) {
            // Refresh the experience list after adding a new experience
            _fetchEmployeeExperiences();
          },
        ),
      ),
    );
  }

  void _addJobVacancy() async {
    // Show interstitial ad before navigating to add job vacancy
    await InterstitialAdsService.instance.showAdIfAvailable(
      context: 'add_job_vacancy',
      onCompleted: () async {
        if (widget.profile == 'business' && widget.userData != null) {
          final result = await Navigator.push(
            context,
            MaterialPageRoute(
              builder: (context) =>
                  CreateJobVacancyScreen(businessId: widget.userData!['id']),
            ),
          );

          // If job vacancy was created successfully, refresh the UI
          if (result == true && mounted) {
            setState(() {});
          }
        } else {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text(
                'Business profile required to create job vacancies',
              ),
              backgroundColor: Colors.orange,
            ),
          );
        }
      },
    );
  }

  void _addWork() {
    // Show interstitial ad before navigating to add work
    InterstitialAdsService.instance.showAdIfAvailable(
      context: 'add_work',
      onCompleted: () {
        Navigator.push(
          context,
          MaterialPageRoute(
            builder: (context) => AddWorkScreen(
              onWorkAdded: (Map<String, dynamic> work) {
                // Refresh the works list after adding a new work
                setState(() {
                  // The WorksList component will handle refreshing itself
                });
              },
            ),
          ),
        );
      },
    );
  }

  @override
  void initState() {
    super.initState();

    // Track user profile editable screen opened
    _analytics.logUserProfileEditableScreenOpened();

    // Set tab count based on profile type
    int tabCount = widget.profile == 'employee'
        ? 5
        : widget.profile == 'business'
        ? 4
        : 3;
    _tabController = TabController(length: tabCount, vsync: this);

    // Fetch profile data based on profile type
    if (widget.profile == 'employee') {
      _fetchEmployeeProfile();
      _fetchEmployeeExperiences();
      _fetchEmployeeAchievements();
      _fetchEmployeeMedia();
      _fetchEmployeeJobOfferings();
      _fetchEmployeeJobApplications();
    } else if (widget.profile == 'professional') {
      _fetchProfessionalProfile();
      _fetchProfessionalMedia();
      _fetchProfessionalConnections();
    } else if (widget.profile == 'business') {
      _fetchBusinessMedia();
      _fetchBusinessJobInvites();
      _fetchBusinessJobApplications();
    }
  }

  @override
  void didUpdateWidget(UserProfileEditableScreen oldWidget) {
    super.didUpdateWidget(oldWidget);

    // Rebuild TabController if profile type changed
    if (oldWidget.profile != widget.profile) {
      _tabController.dispose();

      int tabCount = widget.profile == 'employee'
          ? 5
          : widget.profile == 'business'
          ? 4
          : 3;

      _tabController = TabController(length: tabCount, vsync: this);
    }
  }

  @override
  void dispose() {
    _tabController.dispose();
    super.dispose();
  }

  // Helper method to get analytics values for employee, professional, and business profiles
  num _getAnalyticsValue(String key, num defaultValue) {
    if (widget.profile == 'employee' && _employeeProfileData != null) {
      return _employeeProfileData!['analytics']?[key] ?? defaultValue;
    } else if (widget.profile == 'professional' &&
        _professionalProfileData != null) {
      return _professionalProfileData!['analytics']?[key] ?? defaultValue;
    } else if (widget.profile == 'business' && widget.userData != null) {
      return widget.userData!['analytics']?[key] ?? defaultValue;
    }
    return defaultValue;
  }

  // Helper method to get display data (prioritizes profile data over widget userData)
  Map<String, dynamic> _getDisplayData() {
    if (widget.profile == 'employee' && _employeeProfileData != null) {
      // Use employee profile data if available
      return {
        'firstName': _employeeProfileData!['first_name'] ?? '',
        'lastName': _employeeProfileData!['last_name'] ?? '',
        'username': _employeeProfileData!['username'] ?? '',
        'bio': _employeeProfileData!['bio'] ?? '',
        'about': _employeeProfileData!['about'] ?? '',
        'email': _employeeProfileData!['email'] ?? '',
        'phone': _employeeProfileData!['phone'] ?? '',
        'profileImageUrl': _employeeProfileData!['img_url'] ?? '',
        'ratePerHour':
            _employeeProfileData!['expected_hourly_rate']?.toDouble() ?? 0.0,
        'minimumHours':
            _employeeProfileData!['minimum_hours_per_week']?.toInt() ?? 0,
        'instagram_url': _employeeProfileData!['instagram_url'] ?? '',
        'facebook_url': _employeeProfileData!['facebook_url'] ?? '',
        'twitter_url': _employeeProfileData!['twitter_url'] ?? '',
        'linkedin_url': _employeeProfileData!['linkedin_url'] ?? '',
        'youtube_url': _employeeProfileData!['youtube_url'] ?? '',
        'website_url': _employeeProfileData!['website_url'] ?? '',
        'github_url': _employeeProfileData!['github_url'] ?? '',
        'address': _employeeProfileData!['address'] ?? '',
        'city': _employeeProfileData!['city'] ?? '',
        'state': _employeeProfileData!['state'] ?? '',
        'country': _employeeProfileData!['country'] ?? '',
        'isVerified': _employeeProfileData!['is_verified'] ?? false,
        'isAvailable': _employeeProfileData!['is_available'] ?? true,
        'skills': _employeeProfileData!['skills'] ?? [],
        'analytics': _employeeProfileData!['analytics'] ?? {},
        'created_at': _employeeProfileData!['created_at'],
        'updated_at': _employeeProfileData!['updated_at'],
      };
    } else if (widget.profile == 'professional' &&
        _professionalProfileData != null) {
      // Use professional profile data if available
      return {
        'firstName': _professionalProfileData!['first_name'] ?? '',
        'lastName': _professionalProfileData!['last_name'] ?? '',
        'username': _professionalProfileData!['username'] ?? '',
        'bio': _professionalProfileData!['bio'] ?? '',
        'about': _professionalProfileData!['about'] ?? '',
        'email': _professionalProfileData!['email'] ?? '',
        'phone': _professionalProfileData!['phone'] ?? '',
        'profileImageUrl': _professionalProfileData!['img_url'] ?? '',
        'ratePerHour':
            _professionalProfileData!['expected_hourly_rate']?.toDouble() ??
            0.0,
        'minimumHours':
            _professionalProfileData!['minimum_hours_per_week']?.toInt() ?? 0,
        'instagram_url': _professionalProfileData!['instagram_url'] ?? '',
        'facebook_url': _professionalProfileData!['facebook_url'] ?? '',
        'twitter_url': _professionalProfileData!['twitter_url'] ?? '',
        'linkedin_url': _professionalProfileData!['linkedin_url'] ?? '',
        'youtube_url': _professionalProfileData!['youtube_url'] ?? '',
        'website_url': _professionalProfileData!['website_url'] ?? '',
        'github_url': _professionalProfileData!['github_url'] ?? '',
        'address': _professionalProfileData!['address'] ?? '',
        'city': _professionalProfileData!['city'] ?? '',
        'state': _professionalProfileData!['state'] ?? '',
        'country': _professionalProfileData!['country'] ?? '',
        'isVerified': _professionalProfileData!['is_verified'] ?? false,
        'isAvailable': _professionalProfileData!['is_available'] ?? true,
        'skills': _professionalProfileData!['skills'] ?? [],
        'analytics': _professionalProfileData!['analytics'] ?? {},
        'created_at': _professionalProfileData!['created_at'],
        'updated_at': _professionalProfileData!['updated_at'],
        'rankingScore':
            _professionalProfileData!['ranking_score']?.toDouble() ?? 0.0,
      };
    } else if (widget.profile == 'business' && widget.userData != null) {
      // Handle business profile data with proper field mapping
      final businessData = widget.userData!;
      return {
        'firstName': businessData['business_name'] ?? 'Business',
        'lastName': '', // Business doesn't have lastName, use empty string
        'username': businessData['username'] ?? '',
        'bio': businessData['bio'] ?? '',
        'about': businessData['about'] ?? '',
        'email': businessData['email'] ?? '',
        'phone': businessData['phone'] ?? '',
        'profileImageUrl': businessData['img_url'] ?? '',
        'ratePerHour': 0.0, // Business doesn't have hourly rate
        'minimumHours': 0, // Business doesn't have minimum hours
        'instagram_url': businessData['instagram_url'] ?? '',
        'facebook_url': businessData['facebook_url'] ?? '',
        'twitter_url': businessData['twitter_url'] ?? '',
        'linkedin_url': businessData['linkedin_url'] ?? '',
        'youtube_url': businessData['youtube_url'] ?? '',
        'website_url': businessData['website_url'] ?? '',
        'github_url': businessData['github_url'] ?? '',
        'address': businessData['address'] ?? '',
        'city': businessData['city'] ?? '',
        'state': businessData['state'] ?? '',
        'country': businessData['country'] ?? '',
        'isVerified': businessData['is_verified'] ?? false,
        'isAvailable': businessData['is_available'] ?? true,
        'analytics': businessData['analytics'] ?? {},
        'created_at': businessData['created_at'],
        'updated_at': businessData['updated_at'],
        'businessName': businessData['business_name'] ?? '',
        'jobVacanciesCount': businessData['job_vacancies_count'] ?? 0,
        'lat': businessData['lat'],
        'lng': businessData['lng'],
        'zipCode': businessData['zip_code'] ?? '',
      };
    } else {
      // Fallback to widget userData or default values
      return widget.userData ??
          {
            'firstName': 'John',
            'lastName': 'Doe',
            'username': '@johndoe',
            'bio': 'Professional seeking opportunities',
            'ratePerHour': 50.0,
            'minimumHours': 20,
            'profileImageUrl': '',
            'isVerified': false,
            'isAvailable': true,
          };
    }
  }

  /// Get about text prioritizing about field over bio field for professional profiles
  String _getAboutText(Map<String, dynamic> displayData) {
    // For professional profiles, prioritize 'about' field over 'bio' field
    if (widget.profile == 'professional') {
      final about = displayData['about'] as String?;
      final bio = displayData['bio'] as String?;

      if (about?.isNotEmpty == true) {
        return about!;
      } else if (bio?.isNotEmpty == true) {
        return bio!;
      } else {
        return 'Professional seeking opportunities to grow and contribute.';
      }
    } else {
      // For other profiles, use bio field
      final bio = displayData['bio'] as String?;
      if (bio?.isNotEmpty == true) {
        return bio!;
      } else {
        return 'Professional seeking opportunities to grow and contribute.';
      }
    }
  }

  Future<void> _fetchEmployeeProfile() async {
    print('üìã UserProfileEditableScreen: Fetching employee profile...');

    try {
      setState(() {
        _isLoadingEmployeeProfile = true;
        _employeeProfileError = null;
      });

      // Send POST request to /view-self-employee-profile/ with empty body and token
      final response = await ApiService.post(
        '/view-self-employee-profile/',
        body: {},
        useBearerToken: true,
      );

      print('üì° UserProfileEditableScreen: Employee profile response:');
      print(response);

      if (response['data'] != null && response['data']['status'] == 200) {
        final employeeData = response['data']['data'];

        print(
          '‚úÖ UserProfileEditableScreen: Employee profile loaded successfully',
        );
        print(
          'üë§ Name: ${employeeData['first_name']} ${employeeData['last_name']}',
        );
        print('üìß Email: ${employeeData['email']}');
        print('üíº Username: ${employeeData['username']}');

        setState(() {
          _employeeProfileData = employeeData;
          _isLoadingEmployeeProfile = false;
        });
      } else {
        final errorMessage =
            response['data']?['message'] ?? 'Failed to load employee profile';
        print(
          '‚ùå UserProfileEditableScreen: Error loading employee profile: $errorMessage',
        );

        setState(() {
          _employeeProfileError = errorMessage;
          _isLoadingEmployeeProfile = false;
        });
      }
    } catch (e) {
      print(
        '‚ùå UserProfileEditableScreen: Exception fetching employee profile: $e',
      );

      setState(() {
        _employeeProfileError = 'Network error: Unable to load profile data';
        _isLoadingEmployeeProfile = false;
      });

      // Show error snackbar to user
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Failed to load employee profile: $e'),
            backgroundColor: Theme.of(context).colorScheme.error,
            action: SnackBarAction(
              label: 'Retry',
              onPressed: _fetchEmployeeProfile,
            ),
          ),
        );
      }
    }
  }

  Future<void> _fetchEmployeeExperiences() async {
    print('üìã UserProfileEditableScreen: Fetching employee experiences...');

    try {
      setState(() {
        _isLoadingExperiences = true;
        _experiencesError = null;
      });

      // Send POST request to /get-employee-experience-private/ with token
      final response = await ApiService.post(
        '/get-employee-experience-private/',
        body: {'is_active': true},
        useBearerToken: true,
      );

      print('üì° UserProfileEditableScreen: Employee experiences response:');
      print(response);

      if (response['data'] != null && response['data']['status'] == 200) {
        final experiencesData = response['data']['data'] as List;

        print(
          '‚úÖ UserProfileEditableScreen: ${experiencesData.length} employee experiences loaded successfully',
        );

        setState(() {
          _employeeExperiences = experiencesData
              .map((exp) => exp as Map<String, dynamic>)
              .toList();
          _isLoadingExperiences = false;
        });
      } else {
        final errorMessage =
            response['data']?['message'] ??
            'Failed to load employee experiences';
        print(
          '‚ùå UserProfileEditableScreen: Error loading employee experiences: $errorMessage',
        );

        setState(() {
          _experiencesError = errorMessage;
          _isLoadingExperiences = false;
        });
      }
    } catch (e) {
      print(
        '‚ùå UserProfileEditableScreen: Exception fetching employee experiences: $e',
      );

      setState(() {
        _experiencesError = 'Network error: Unable to load experience data';
        _isLoadingExperiences = false;
      });

      // Show error snackbar to user
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Failed to load employee experiences: $e'),
            backgroundColor: Theme.of(context).colorScheme.error,
            action: SnackBarAction(
              label: 'Retry',
              onPressed: _fetchEmployeeExperiences,
            ),
          ),
        );
      }
    }
  }

  Future<void> _fetchEmployeeAchievements() async {
    print('üìã UserProfileEditableScreen: Fetching employee achievements...');

    try {
      setState(() {
        _isLoadingAchievements = true;
        _achievementsError = null;
      });

      // Send POST request to /get-employee-achievements-private/ with token
      final response = await ApiService.post(
        '/get-employee-achievements-private/',
        body: {'is_active': true},
        useBearerToken: true,
      );

      print('üì° UserProfileEditableScreen: Employee achievements response:');
      print(response);

      if (response['data'] != null && response['data']['status'] == 200) {
        final achievementsData = response['data']['data'] as List;

        print(
          '‚úÖ UserProfileEditableScreen: ${achievementsData.length} employee achievements loaded successfully',
        );

        setState(() {
          _employeeAchievements = achievementsData
              .map((achievement) => achievement as Map<String, dynamic>)
              .toList();
          _isLoadingAchievements = false;
        });
      } else {
        final errorMessage =
            response['data']?['message'] ??
            'Failed to load employee achievements';
        print(
          '‚ùå UserProfileEditableScreen: Error loading employee achievements: $errorMessage',
        );

        setState(() {
          _achievementsError = errorMessage;
          _isLoadingAchievements = false;
        });
      }
    } catch (e) {
      print(
        '‚ùå UserProfileEditableScreen: Exception fetching employee achievements: $e',
      );

      setState(() {
        _achievementsError = 'Network error: Unable to load achievement data';
        _isLoadingAchievements = false;
      });

      // Show error snackbar to user
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Failed to load employee achievements: $e'),
            backgroundColor: Theme.of(context).colorScheme.error,
            action: SnackBarAction(
              label: 'Retry',
              onPressed: _fetchEmployeeAchievements,
            ),
          ),
        );
      }
    }
  }

  Future<void> _fetchEmployeeMedia() async {
    print('üìã UserProfileEditableScreen: Fetching employee media...');

    try {
      setState(() {
        _isLoadingMedia = true;
        _mediaError = null;
      });

      // Send POST request to /get-employee-media-private/ with token
      final response = await ApiService.post(
        '/get-employee-media-private/',
        body: {'is_active': true},
        useBearerToken: true,
      );

      print('üì° UserProfileEditableScreen: Employee media response:');
      print(response);

      if (response['data'] != null && response['data']['status'] == 200) {
        final mediaData = response['data']['data'] as List;

        print(
          '‚úÖ UserProfileEditableScreen: ${mediaData.length} employee media items loaded successfully',
        );

        setState(() {
          _employeeMedia = mediaData
              .map((media) => media as Map<String, dynamic>)
              .toList();
          _isLoadingMedia = false;
        });
      } else {
        final errorMessage =
            response['data']?['message'] ?? 'Failed to load employee media';
        print(
          '‚ùå UserProfileEditableScreen: Error loading employee media: $errorMessage',
        );

        setState(() {
          _mediaError = errorMessage;
          _isLoadingMedia = false;
        });
      }
    } catch (e) {
      print(
        '‚ùå UserProfileEditableScreen: Exception fetching employee media: $e',
      );

      setState(() {
        _mediaError = 'Network error: Unable to load media data';
        _isLoadingMedia = false;
      });

      // Show error snackbar to user
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Failed to load employee media: $e'),
            backgroundColor: Theme.of(context).colorScheme.error,
            action: SnackBarAction(
              label: 'Retry',
              onPressed: _fetchEmployeeMedia,
            ),
          ),
        );
      }
    }
  }

  Future<void> _fetchProfessionalProfile() async {
    print('üìã UserProfileEditableScreen: Fetching professional profile...');
    
    // DISABLED: ProfessionalService removed
    print('‚ö†Ô∏è Professional profile fetching temporarily disabled');
    setState(() {
      _professionalProfileError = 'Professional service temporarily unavailable';
      _isLoadingProfessionalProfile = false;
    });
    
    /* ORIGINAL CODE - COMMENTED OUT
    try {
      setState(() {
        _isLoadingProfessionalProfile = true;
        _professionalProfileError = null;
      });

      // Use ProfessionalService to fetch profile data
      final professionalData =
          await ProfessionalService.getSelfProfessionalProfile();

      print(
        '‚úÖ UserProfileEditableScreen: Professional profile loaded successfully',
      );
      print(
        'üë§ Name: ${professionalData['first_name']} ${professionalData['last_name']}',
      );
      print('üìß Email: ${professionalData['email']}');
      print('üíº Username: ${professionalData['username']}');

      setState(() {
        _professionalProfileData = professionalData;
        _isLoadingProfessionalProfile = false;
      });
    } catch (e) {
      print(
        '‚ùå UserProfileEditableScreen: Exception fetching professional profile: $e',
      );

      setState(() {
        _professionalProfileError =
            'Network error: Unable to load profile data';
        _isLoadingProfessionalProfile = false;
      });

      // Show error snackbar to user
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Failed to load professional profile: $e'),
            backgroundColor: Theme.of(context).colorScheme.error,
            action: SnackBarAction(
              label: 'Retry',
              onPressed: _fetchProfessionalProfile,
            ),
          ),
        );
      }
    }
    */

  Future<void> _fetchProfessionalMedia() async {
    print('üìã UserProfileEditableScreen: Fetching professional media...');

    try {
      setState(() {
        _isLoadingProfessionalMedia = true;
        _professionalMediaError = null;
      });

// REMOVED:       // Use ProfessionalService to fetch media data
// REMOVED:       final mediaData = await ProfessionalService.getProfessionalMedia(
// REMOVED:         isActive: true,
// REMOVED:       );

      print(
        '‚úÖ UserProfileEditableScreen: ${mediaData.length} professional media items loaded successfully',
      );

      setState(() {
        _professionalMedia = mediaData;
        _isLoadingProfessionalMedia = false;
      });
    } catch (e) {
      print(
        '‚ùå UserProfileEditableScreen: Exception fetching professional media: $e',
      );

      setState(() {
        _professionalMediaError = 'Network error: Unable to load media data';
        _isLoadingProfessionalMedia = false;
      });

      // Show error snackbar to user
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Failed to load professional media: $e'),
            backgroundColor: Theme.of(context).colorScheme.error,
            action: SnackBarAction(
              label: 'Retry',
              onPressed: _fetchProfessionalMedia,
            ),
          ),
        );
      }
    }
  }

  Future<void> _fetchBusinessMedia() async {
    print('üìã UserProfileEditableScreen: Fetching business media...');

    if (widget.userData == null || widget.userData!['id'] == null) {
      print('‚ùå UserProfileEditableScreen: No business ID available');
      return;
    }

    final businessId = widget.userData!['id'];

    try {
      setState(() {
        _isLoadingBusinessMedia = true;
        _businessMediaError = null;
      });

// REMOVED:       // Fetch business media using BusinessService
// REMOVED:       final mediaData = await BusinessService.getBusinessMedia(
// REMOVED:         businessId,
// REMOVED:         isActive: true,
// REMOVED:       );

      print(
        '‚úÖ UserProfileEditableScreen: ${mediaData.length} business media items loaded successfully',
      );

      setState(() {
        _businessMedia = mediaData;
        _isLoadingBusinessMedia = false;
      });
    } catch (e) {
      print(
        '‚ùå UserProfileEditableScreen: Exception fetching business media: $e',
      );

      setState(() {
        _businessMediaError = 'Network error: Unable to load media data';
        _isLoadingBusinessMedia = false;
      });

      // Show error snackbar to user
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Failed to load business media: $e'),
            backgroundColor: Theme.of(context).colorScheme.error,
            action: SnackBarAction(
              label: 'Retry',
              onPressed: _fetchBusinessMedia,
            ),
          ),
        );
      }
    }
  }

  Future<void> _fetchProfessionalConnections() async {
    print('üìã UserProfileEditableScreen: Fetching professional connections...');

    try {
      setState(() {
        _isLoadingProfessionalConnections = true;
        _professionalConnectionsError = null;
      });

// REMOVED:       // Use ProfessionalService to fetch connections data
// REMOVED:       final connectionsData =
// REMOVED:           await ProfessionalService.getProfessionalConnections();

      print(
        '‚úÖ UserProfileEditableScreen: ${connectionsData['data'].length} professional connections loaded successfully',
      );
      print('üìä Total connections count: ${connectionsData['count']}');

      setState(() {
        _professionalConnections = connectionsData['data'];
        _connectionsMetadata = {
          'count': connectionsData['count'],
          'pagination': connectionsData['pagination'],
          'access_info': connectionsData['access_info'],
        };
        _isLoadingProfessionalConnections = false;
      });
    } catch (e) {
      print(
        '‚ùå UserProfileEditableScreen: Exception fetching professional connections: $e',
      );

      setState(() {
        _professionalConnectionsError =
            'Network error: Unable to load connections data';
        _isLoadingProfessionalConnections = false;
      });

      // Show error snackbar to user
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Failed to load professional connections: $e'),
            backgroundColor: Theme.of(context).colorScheme.error,
            action: SnackBarAction(
              label: 'Retry',
              onPressed: _fetchProfessionalConnections,
            ),
          ),
        );
      }
    }
  }

  /// Handle connection accept/reject response
  Future<void> _handleConnectionResponse(
    String connectionId,
    bool isAccepted,
  ) async {
    print(
      'üîÑ ${isAccepted ? 'Accepting' : 'Rejecting'} connection: $connectionId',
    );

    try {
      // Show loading state
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Row(
            children: [
              SizedBox(
                width: 16,
                height: 16,
                child: CircularProgressIndicator(
                  strokeWidth: 2,
                  valueColor: AlwaysStoppedAnimation<Color>(Colors.white),
                ),
              ),
              const SizedBox(width: 12),
              Expanded(
                child: Text(
                  '${isAccepted ? 'Accepting' : 'Rejecting'} connection...',
                ),
              ),
            ],
          ),
          backgroundColor: Colors.blue,
          behavior: SnackBarBehavior.floating,
          margin: const EdgeInsets.all(16),
          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
          duration: const Duration(seconds: 2),
        ),
      );

      // Make API call to update connection
      final response = await ApiService.put(
        '/edit-professional-connection/',
        body: {'connection_id': connectionId, 'is_accepted': isAccepted},
        useBearerToken: true,
      );

      print('üîÑ Connection response: $response');

      // Check if request was successful
      if (response['data'] != null && response['data']['status'] == 200) {
        // Update the local connection data
        setState(() {
          final connectionIndex = _professionalConnections.indexWhere(
            (connection) => connection['id'] == connectionId,
          );
          if (connectionIndex != -1) {
            _professionalConnections[connectionIndex]['is_accepted'] =
                isAccepted;
          }
        });

        // Show success message
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Row(
              children: [
                Icon(
                  isAccepted ? Icons.check_circle : Icons.cancel,
                  color: Colors.white,
                  size: 20,
                ),
                const SizedBox(width: 12),
                Expanded(
                  child: Text(
                    'Connection ${isAccepted ? 'accepted' : 'rejected'} successfully!',
                  ),
                ),
              ],
            ),
            backgroundColor: isAccepted ? Colors.green : Colors.orange,
            behavior: SnackBarBehavior.floating,
            margin: const EdgeInsets.all(16),
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(8),
            ),
          ),
        );

        print(
          '‚úÖ Connection ${isAccepted ? 'accepted' : 'rejected'} successfully',
        );
      } else {
        // Handle API error response
        final errorMessage =
            response['data']?['message'] ??
            'Failed to ${isAccepted ? 'accept' : 'reject'} connection';
        throw Exception(errorMessage);
      }
    } catch (e) {
      print('‚ùå Error ${isAccepted ? 'accepting' : 'rejecting'} connection: $e');

      // Show error message
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Row(
            children: [
              const Icon(Icons.error_outline, color: Colors.white, size: 20),
              const SizedBox(width: 12),
              Expanded(
                child: Text(
                  'Failed to ${isAccepted ? 'accept' : 'reject'} connection: ${e.toString()}',
                ),
              ),
            ],
          ),
          backgroundColor: Colors.red,
          behavior: SnackBarBehavior.floating,
          margin: const EdgeInsets.all(16),
          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
          duration: const Duration(seconds: 4),
        ),
      );
    }
  }

  Future<void> _fetchEmployeeJobOfferings() async {
    print('üìã UserProfileEditableScreen: Fetching employee job offerings...');

    try {
      setState(() {
        _isLoadingEmployeeJobOfferings = true;
        _employeeJobOfferingsError = null;
      });

      // Use EmployeeService to fetch job offerings data
// REMOVED:       final jobOfferingsData = await EmployeeService.getEmployeeJobOfferings();

      print(
        '‚úÖ UserProfileEditableScreen: ${jobOfferingsData['data'].length} employee job offerings loaded successfully',
      );
      print('üìä Total job offerings count: ${jobOfferingsData['count']}');

      setState(() {
        _employeeJobOfferings = jobOfferingsData['data'];
        _jobOfferingsMetadata = {
          'count': jobOfferingsData['count'],
          'pagination': jobOfferingsData['pagination'],
          'access_info': jobOfferingsData['access_info'],
        };
        _isLoadingEmployeeJobOfferings = false;
      });
    } catch (e) {
      print(
        '‚ùå UserProfileEditableScreen: Exception fetching employee job offerings: $e',
      );

      setState(() {
        _employeeJobOfferingsError =
            'Network error: Unable to load job offerings data';
        _isLoadingEmployeeJobOfferings = false;
      });

      // Show error snackbar to user
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Failed to load employee job offerings: $e'),
            backgroundColor: Theme.of(context).colorScheme.error,
            action: SnackBarAction(
              label: 'Retry',
              onPressed: _fetchEmployeeJobOfferings,
            ),
          ),
        );
      }
    }
  }

  Future<void> _fetchBusinessJobInvites() async {
    if (widget.userData == null) return;

    print('üìã UserProfileEditableScreen: Fetching business job invites...');

    try {
      setState(() {
        _isLoadingBusinessJobInvites = true;
        _businessJobInvitesError = null;
      });

      final response = await ApiService.post(
        '/get-my-jobofferings/',
        body: {'business_id': widget.userData!['id']},
        useBearerToken: true,
      );

      print('üì° UserProfileEditableScreen: Job invites response:');
      print(response);

      if (response['data'] != null && response['data']['status'] == 200) {
        final jobInvitesData = response['data']['data'] as List? ?? [];
        final metadata = {
          'count': response['data']['count'] ?? 0,
          'pagination': response['data']['pagination'] ?? {},
        };

        print('‚úÖ UserProfileEditableScreen: Job invites loaded successfully');
        print('üìä Count: ${jobInvitesData.length} invites');

        setState(() {
          _businessJobInvites = jobInvitesData.cast<Map<String, dynamic>>();
          _jobInvitesMetadata = metadata;
          _isLoadingBusinessJobInvites = false;
        });
      } else {
        final errorMessage =
            response['data']?['message'] ?? 'Failed to load job invites';
        print(
          '‚ùå UserProfileEditableScreen: Error loading job invites: $errorMessage',
        );

        setState(() {
          _businessJobInvitesError = errorMessage;
          _isLoadingBusinessJobInvites = false;
        });
      }
    } catch (e) {
      print('‚ùå UserProfileEditableScreen: Job invites fetch error: $e');
      setState(() {
        _businessJobInvitesError = 'Network error occurred';
        _isLoadingBusinessJobInvites = false;
      });
    }
  }

  Future<void> _fetchBusinessJobApplications() async {
    if (widget.userData == null) return;

    print(
      'üìã UserProfileEditableScreen: Fetching business job applications...',
    );

    try {
      setState(() {
        _isLoadingBusinessJobApplications = true;
        _businessJobApplicationsError = null;
      });

      final response = await ApiService.post(
        '/get-business-jobapplication-private/',
        body: {},
        useBearerToken: true,
      );

      print('üì° UserProfileEditableScreen: Job applications response:');
      print(response);

      if (response['data'] != null && response['data']['status'] == 200) {
        final jobApplicationsData = response['data']['data'] as List? ?? [];
        final metadata = {
          'count': response['data']['count'] ?? 0,
          'pagination': response['data']['pagination'] ?? {},
          'access_info': response['data']['access_info'] ?? {},
        };

        print(
          '‚úÖ UserProfileEditableScreen: Job applications loaded successfully',
        );
        print('üìä Count: ${jobApplicationsData.length} applications');

        setState(() {
          _businessJobApplications = jobApplicationsData
              .cast<Map<String, dynamic>>();
          _jobApplicationsMetadata = metadata;
          _isLoadingBusinessJobApplications = false;
        });
      } else {
        final errorMessage =
            response['data']?['message'] ?? 'Failed to load job applications';
        print(
          '‚ùå UserProfileEditableScreen: Error loading job applications: $errorMessage',
        );

        setState(() {
          _businessJobApplicationsError = errorMessage;
          _isLoadingBusinessJobApplications = false;
        });
      }
    } catch (e) {
      print('‚ùå UserProfileEditableScreen: Job applications fetch error: $e');
      setState(() {
        _businessJobApplicationsError = 'Network error occurred';
        _isLoadingBusinessJobApplications = false;
      });
    }
  }

  // Helper methods for unified media handling
  bool _isMediaLoading() {
    switch (widget.profile) {
      case 'employee':
        return _isLoadingMedia;
      case 'professional':
        return _isLoadingProfessionalMedia;
      case 'business':
        return _isLoadingBusinessMedia;
      default:
        return false;
    }
  }

  String? _getMediaError() {
    switch (widget.profile) {
      case 'employee':
        return _mediaError;
      case 'professional':
        return _professionalMediaError;
      case 'business':
        return _businessMediaError;
      default:
        return null;
    }
  }

  List<Map<String, dynamic>> _getMediaList() {
    switch (widget.profile) {
      case 'employee':
        return _employeeMedia;
      case 'professional':
        return _professionalMedia;
      case 'business':
        return _businessMedia;
      default:
        return [];
    }
  }

  void _refreshMedia() {
    switch (widget.profile) {
      case 'employee':
        _fetchEmployeeMedia();
        break;
      case 'professional':
        _fetchProfessionalMedia();
        break;
      case 'business':
        _fetchBusinessMedia();
        _fetchBusinessJobInvites();
        break;
    }
  }

  Future<void> _refreshBusinessProfile() async {
    if (widget.userData == null || widget.userData!['id'] == null) {
      print(
        '‚ùå UserProfileEditableScreen: No business ID available for refresh',
      );
      return;
    }

    try {
      final businessId = widget.userData!['id'];
      final updatedBusinessData =
          await BusinessService.getBusinessProfileForEdit(businessId);

      // Update the widget userData with fresh data
      setState(() {
        widget.userData!.addAll(updatedBusinessData);
      });

      print(
        '‚úÖ UserProfileEditableScreen: Business profile refreshed successfully',
      );
    } catch (e) {
      print(
        '‚ùå UserProfileEditableScreen: Error refreshing business profile: $e',
      );
    }
  }

  Future<void> _handleRefresh() async {
    print(
      'üîÑ UserProfileEditableScreen: Refreshing ${widget.profile} profile...',
    );

    try {
      if (widget.profile == 'employee') {
        await Future.wait([
          _fetchEmployeeProfile(),
          _fetchEmployeeExperiences(),
          _fetchEmployeeAchievements(),
          _fetchEmployeeMedia(),
          _fetchEmployeeJobOfferings(),
          _fetchEmployeeJobApplications(),
        ]);
      } else if (widget.profile == 'professional') {
        await Future.wait([
          _fetchProfessionalProfile(),
          _fetchProfessionalMedia(),
          _fetchProfessionalConnections(),
        ]);
      } else if (widget.profile == 'business') {
        await Future.wait([
          _fetchBusinessMedia(),
          _fetchBusinessJobInvites(),
          _fetchBusinessJobApplications(),
        ]);
      }

      print(
        '‚úÖ UserProfileEditableScreen: ${widget.profile} profile refresh completed',
      );
    } catch (e) {
      print('‚ùå Error during profile refresh: $e');

      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Failed to refresh profile: $e'),
            backgroundColor: Theme.of(context).colorScheme.error,
          ),
        );
      }
    }
  }

  void _editProfile() async {
    // Show loading indicator
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => const Center(child: CircularProgressIndicator()),
    );

    try {
      if (widget.profile == 'employee' && _employeeProfileData != null) {
        // Close loading dialog
        if (mounted) Navigator.pop(context);

        // Navigate to edit employee profile screen with employee data
        final result = await Navigator.push(
          context,
          MaterialPageRoute(
            builder: (context) =>
                EditEmployeeProfileScreen(userData: _employeeProfileData!),
          ),
        );

        // If data was updated, refresh the profile
        if (result != null && result is Map<String, dynamic>) {
          setState(() {
            _employeeProfileData = result;
          });
        }
      } else if (widget.profile == 'professional' &&
          _professionalProfileData != null) {
        // Close loading dialog
        if (mounted) Navigator.pop(context);

        // Navigate to edit professional profile screen with professional data
        final result = await Navigator.push(
          context,
          MaterialPageRoute(
            builder: (context) => EditProfessionalProfileScreen(
              userData: _professionalProfileData!,
            ),
          ),
        );

        // If data was updated, refresh the profile
        if (result != null && result is Map<String, dynamic>) {
          setState(() {
            _professionalProfileData = result;
          });
        }
      } else if (widget.profile == 'business' && widget.userData != null) {
        // Close loading dialog
        if (mounted) Navigator.pop(context);

        // Navigate to business profile edit screen with business data
        final result = await Navigator.push(
          context,
          MaterialPageRoute(
            builder: (context) => MyBusinessProfileOnboardingScreen(
              isEdit: true,
              userData: widget.userData!,
            ),
          ),
        );

        // If data was updated, you might want to refresh the business profile
        // For now, we'll just show a success message
        if (result != null) {
          // Update the business profile data if result contains updated data
          if (result is Map<String, dynamic>) {
            // Refresh the business profile data
            await _refreshBusinessProfile();
          }

          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text('Business profile updated successfully!'),
              backgroundColor: Colors.green,
            ),
          );
        }
      } else {
        // Fallback to original logic for non-employee profiles or when no employee data
        print('üìù Using fallback user data for editing');

        // Get phone number from SharedPreferences
        final prefs = await SharedPreferences.getInstance();
        final phoneNumber = prefs.getString('phone_number');

        if (phoneNumber != null) {
          // Fetch current user data from API
          final response = await ApiService.post(
            '/view-user-data/',
            body: {'phone_number': phoneNumber},
            useBearerToken: true,
          );

          // Close loading dialog
          if (mounted) Navigator.pop(context);

          if (response['data'] != null && response['data']['status'] == 200) {
            final userData = response['data']['response'][0];

            // Navigate to edit profile screen with user data
            Navigator.push(
              context,
              MaterialPageRoute(
                builder: (context) => EditProfileScreen(userData: userData),
              ),
            );
          } else {
            // If API fails, show error
            ScaffoldMessenger.of(context).showSnackBar(
              const SnackBar(
                content: Text('Failed to load user data for editing'),
                backgroundColor: Colors.red,
              ),
            );
          }
        } else {
          // Close loading dialog
          if (mounted) Navigator.pop(context);

          // Show error if no phone number
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text('Unable to edit profile: No phone number found'),
              backgroundColor: Colors.red,
            ),
          );
        }
      }
    } catch (e) {
      // Close loading dialog
      if (mounted) Navigator.pop(context);

      print('Error preparing edit data: $e');

      // Show error message
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Error preparing profile data: $e'),
          backgroundColor: Colors.red,
        ),
      );
    }
  }

  void _showFloatingActionOptions() {
    List<Map<String, dynamic>> options = [];

    switch (widget.profile) {
      case 'employee':
        options = [
          {
            'icon': Icons.emoji_events,
            'title': 'Add Achievements',
            'description': 'Showcase your accomplishments',
          },
          {
            'icon': Icons.work,
            'title': 'Add Experience',
            'description': 'Add your work experience',
          },
        ];
        break;
      case 'business':
        options = [
          {
            'icon': Icons.business_center,
            'title': 'Add Job Vacancies',
            'description': 'Post new job opportunities',
          },
        ];
        break;
      case 'professional':
        options = [
          {
            'icon': Icons.work_outline,
            'title': 'Add Works',
            'description': 'Showcase your portfolio',
          },
        ];
        break;
    }

    showModalBottomSheet(
      context: context,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
      ),
      isScrollControlled: true,
      builder: (BuildContext context) {
        return ConstrainedBox(
          constraints: BoxConstraints(
            maxHeight: MediaQuery.of(context).size.height * 0.7,
          ),
          child: SingleChildScrollView(
            padding: const EdgeInsets.all(20),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                Container(
                  width: 40,
                  height: 4,
                  decoration: BoxDecoration(
                    color: Colors.grey[300],
                    borderRadius: BorderRadius.circular(2),
                  ),
                ),
                const SizedBox(height: 20),
                const Text(
                  'Add Content',
                  style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold),
                ),
                const SizedBox(height: 20),
                ...options.map(
                  (option) => _buildOptionTile(
                    icon: option['icon'],
                    title: option['title'],
                    description: option['description'],
                    onTap: () {
                      Navigator.pop(context);
                      if (option['title'] == 'Add Achievements') {
                        _addAchievement();
                      } else if (option['title'] == 'Add Experience') {
                        _addExperience();
                      } else if (option['title'] == 'Add Job Vacancies') {
                        _addJobVacancy();
                      } else if (option['title'] == 'Add Works') {
                        _addWork();
                      } else {
                        ScaffoldMessenger.of(context).showSnackBar(
                          SnackBar(
                            content: Text(
                              '${option['title']} feature coming soon!',
                            ),
                          ),
                        );
                      }
                    },
                  ),
                ),
                SizedBox(height: MediaQuery.of(context).viewInsets.bottom + 20),
              ],
            ),
          ),
        );
      },
    );
  }

  Widget _buildOptionTile({
    required IconData icon,
    required String title,
    required String description,
    required VoidCallback onTap,
  }) {
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(12),
      child: Container(
        width: double.infinity,
        padding: const EdgeInsets.all(16),
        margin: const EdgeInsets.only(bottom: 12),
        decoration: BoxDecoration(
          border: Border.all(color: Colors.grey[300]!),
          borderRadius: BorderRadius.circular(12),
        ),
        child: Row(
          children: [
            Container(
              padding: const EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: Colors.blue.withOpacity(0.1),
                borderRadius: BorderRadius.circular(8),
              ),
              child: Icon(icon, color: Colors.blue, size: 24),
            ),
            const SizedBox(width: 16),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    title,
                    style: const TextStyle(
                      fontSize: 16,
                      fontWeight: FontWeight.w600,
                    ),
                  ),
                  const SizedBox(height: 4),
                  Text(
                    description,
                    style: TextStyle(fontSize: 14, color: Colors.grey[600]),
                  ),
                ],
              ),
            ),
            const Icon(Icons.chevron_right, color: Colors.grey),
          ],
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final displayData = _getDisplayData();

    return UniversalTranslationWrapper(
      excludePatterns: [
        'email',
        'phone',
        '@',
        'http',
        'www',
        '.com',
        '.org',
        '.net',
        'id',
        'url',
        'img_url',
        'media_url',
        'github_url',
        'linkedin_url',
        'facebook_url',
        'instagram_url',
        'twitter_url',
        'youtube_url',
        'website_url',
      ],
      child: Scaffold(
        backgroundColor: theme.colorScheme.background,
        appBar: AppBar(
          title: const TranslatedText('My Profile'),
          backgroundColor: Colors.transparent,
          elevation: 0,
          leading: IconButton(
            icon: const Icon(Icons.arrow_back),
            onPressed: () => Navigator.pop(context),
          ),
          actions: [
            // Refresh button for all profile types
            IconButton(
              icon: Icon(Icons.refresh, color: theme.colorScheme.onSurface),
              onPressed:
                  _isLoadingEmployeeProfile ||
                      _isLoadingProfessionalProfile ||
                      _isLoadingBusinessMedia
                  ? null
                  : _handleRefresh,
            ),
          ],
        ),
        body:
            (_isLoadingEmployeeProfile && widget.profile == 'employee') ||
                (_isLoadingProfessionalProfile &&
                    widget.profile == 'professional')
            ? Center(
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    const CircularProgressIndicator(),
                    const SizedBox(height: 16),
                    Text('Loading ${widget.profile} profile...'),
                  ],
                ),
              )
            : (_employeeProfileError != null && widget.profile == 'employee') ||
                  (_professionalProfileError != null &&
                      widget.profile == 'professional')
            ? Center(
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    Icon(
                      Icons.error_outline,
                      size: 64,
                      color: theme.colorScheme.error,
                    ),
                    const SizedBox(height: 16),
                    Text(
                      'Failed to load ${widget.profile} profile',
                      style: theme.textTheme.titleLarge,
                    ),
                    const SizedBox(height: 8),
                    Text(
                      widget.profile == 'employee'
                          ? _employeeProfileError!
                          : _professionalProfileError!,
                      style: theme.textTheme.bodyMedium?.copyWith(
                        color: theme.colorScheme.onSurface.withOpacity(0.7),
                      ),
                      textAlign: TextAlign.center,
                    ),
                    const SizedBox(height: 24),
                    ElevatedButton(
                      onPressed: widget.profile == 'employee'
                          ? _fetchEmployeeProfile
                          : _fetchProfessionalProfile,
                      child: const TranslatedText('Retry'),
                    ),
                  ],
                ),
              )
            : RefreshIndicator(
                onRefresh: _handleRefresh,
                child: NestedScrollView(
                  headerSliverBuilder: (context, innerBoxIsScrolled) {
                    return [
                      SliverToBoxAdapter(
                        child: Column(
                          children: [
                            const SizedBox(height: 20),
                            // Debug info for employee profile (optional)
                            if (widget.profile == 'employee' &&
                                _employeeProfileData != null)
                              Container(
                                margin: const EdgeInsets.symmetric(
                                  horizontal: 16,
                                ),
                                padding: const EdgeInsets.all(12),
                                decoration: BoxDecoration(
                                  color: theme.colorScheme.surfaceVariant
                                      .withOpacity(0.3),
                                  borderRadius: BorderRadius.circular(8),
                                  border: Border.all(
                                    color: theme.colorScheme.outline
                                        .withOpacity(0.2),
                                  ),
                                ),
                                child: Row(
                                  children: [
                                    Icon(
                                      Icons.info_outline,
                                      size: 16,
                                      color: theme.colorScheme.primary,
                                    ),
                                    const SizedBox(width: 8),
                                    Expanded(
                                      child: Text(
                                        'Employee profile loaded successfully',
                                        style: theme.textTheme.bodySmall
                                            ?.copyWith(
                                              color: theme.colorScheme.onSurface
                                                  .withOpacity(0.7),
                                            ),
                                      ),
                                    ),
                                    if (_employeeProfileData!['skills']
                                            ?.isNotEmpty ==
                                        true)
                                      Container(
                                        padding: const EdgeInsets.symmetric(
                                          horizontal: 8,
                                          vertical: 2,
                                        ),
                                        decoration: BoxDecoration(
                                          color: theme.colorScheme.primary
                                              .withOpacity(0.1),
                                          borderRadius: BorderRadius.circular(
                                            12,
                                          ),
                                        ),
                                        child: Text(
                                          '${_employeeProfileData!['skills_count'] ?? _employeeProfileData!['skills']?.length ?? 0} skills',
                                          style: theme.textTheme.labelSmall
                                              ?.copyWith(
                                                color:
                                                    theme.colorScheme.primary,
                                                fontWeight: FontWeight.w600,
                                              ),
                                        ),
                                      ),
                                  ],
                                ),
                              ),
                            if (widget.profile == 'employee')
                              const SizedBox(height: 16),
                            // Profile Header
                            ProfileHeaderCardEditable(
                              userName: widget.profile == 'business'
                                  ? (displayData['firstName']?.isNotEmpty ==
                                            true
                                        ? displayData['firstName']
                                        : 'Business Name')
                                  : ('${displayData['firstName']} ${displayData['lastName']}'
                                            .trim()
                                            .isNotEmpty
                                        ? '${displayData['firstName']} ${displayData['lastName']}'
                                              .trim()
                                        : 'Employee Name'),
                              userHandle:
                                  displayData['username']?.isNotEmpty == true
                                  ? '@${displayData['username']}'
                                  : widget.profile == 'business'
                                  ? '@business'
                                  : '@employee',
                              userBio: displayData['bio']?.isNotEmpty == true
                                  ? displayData['bio']
                                  : widget.profile == 'business'
                                  ? 'Business profile'
                                  : 'Employee profile',
                              profileImageUrl:
                                  displayData['profileImageUrl'] ?? '',
                              isVerified: displayData['isVerified'] ?? false,
                              isOnline: true,
                              isAvailable: displayData['isAvailable'] ?? true,
                              onEditProfileImage: () {
                                debugPrint(
                                  'üîóüîóüîó Parent screen: onEditProfileImage callback triggered',
                                );
                                _showProfileImagePicker();
                              },
                              onAvailableStatusChanged:
                                  _handleAvailableStatusChange,
                            ),
                            const SizedBox(height: 16),
                            // Profile Stats with Edit Button (only show for employee profiles)
                            if (widget.profile == 'employee')
                              ProfileStatsCardEditable(
                                hourlyRate:
                                    displayData['ratePerHour']?.toDouble() ??
                                    50.0,
                                minHoursPerWeek:
                                    displayData['minimumHours']?.toInt() ?? 20,
                                onEditPressed: _editProfile,
                              ),
                            if (widget.profile == 'employee')
                              const SizedBox(height: 16),
                            // Grow with Ads Card (for all profiles)
                            GrowWithAdsCard(
                              profileType: widget
                                  .profile, // Add the required profileType parameter
                              initialCpc: 0, // Changed from 0.0 to 0 (int)
                              currentCpc:
                                  _getCurrentCpc(), // Add current CPC from profile data
                              adsCreditsLeft: 0.0, // TODO: Get from API
                              adsCreditsSpent: 0.0, // TODO: Get from API
                              initialIsEnabled: false, // Default disabled
                              onCpcChanged: (int cpc) {
                                // Changed from double to int
                                // TODO: Save CPC to API
                                print('CPC changed to: $cpc');
                              },
                              onToggleChanged: (bool isEnabled) {
                                // TODO: Save enabled state to API
                                print('Ads enabled: $isEnabled');
                              },
                            ),
                            const SizedBox(height: 16),
                            // Edit Profile Card
                            EditProfileCard(
                              onEditProfile: _editProfile,
                              profileType: widget.profile,
                            ),
                            const SizedBox(height: 16),
                            // Analytics Card
                            ProfileAnalyticsCard(
                              postCount: _getAnalyticsValue(
                                'post_count',
                                245,
                              ).toInt(),
                              likeCount: _getAnalyticsValue(
                                'like_count',
                                8200,
                              ).toInt(),
                              viewCount: _getAnalyticsValue(
                                'view_count',
                                15400,
                              ).toInt(),
                              clickCount: _getAnalyticsValue(
                                'click_count',
                                2100,
                              ).toInt(),
                              reviewCount: _getAnalyticsValue(
                                'review_count',
                                128,
                              ).toInt(),
                              rating: _getAnalyticsValue(
                                'average_rating',
                                4.8,
                              ).toDouble(),
                            ),
                            const SizedBox(height: 16),
                            // Social Media Links
                            SocialMediaLinksCard(
                              userData: widget.profile == 'employee'
                                  ? (_employeeProfileData ?? displayData)
                                  : (widget.userData ?? displayData),
                            ),
                            const SizedBox(height: 24),
                            // Editable Media Gallery
                            _buildMediaGallerySection(),
                            const SizedBox(height: 24),
                            // Tabs
                            Container(
                              margin: const EdgeInsets.symmetric(
                                horizontal: 16,
                              ),
                              child: TabBar(
                                controller: _tabController,
                                labelColor: theme.colorScheme.primary,
                                unselectedLabelColor: theme
                                    .colorScheme
                                    .onSurface
                                    .withOpacity(0.6),
                                indicatorColor: theme.colorScheme.primary,
                                tabs: _buildTabs(),
                              ),
                            ),
                          ],
                        ),
                      ),
                    ];
                  },
                  body: TabBarView(
                    controller: _tabController,
                    children: _buildTabViews(),
                  ),
                ),
              ),
        floatingActionButton: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            // Messages button
            FloatingActionButton(
              heroTag: 'messages',
              onPressed: () {
                ScaffoldMessenger.of(context).showSnackBar(
                  const SnackBar(
                    content: Text('Messages feature coming soon!'),
                  ),
                );
              },
              backgroundColor: theme.colorScheme.secondary,
              child: const Icon(Icons.message, color: Colors.white),
            ),
            const SizedBox(height: 16),
            // Add content button
            FloatingActionButton(
              heroTag: 'add',
              onPressed: _showFloatingActionOptions,
              backgroundColor: theme.colorScheme.primary,
              child: const Icon(Icons.add, color: Colors.white),
            ),
          ],
        ),
      ),
    );
  }

  List<Widget> _buildTabs() {
    switch (widget.profile) {
      case 'employee':
        return [
          const Tab(child: TranslatedText('About')),
          const Tab(child: TranslatedText('Achievements')),
          const Tab(child: TranslatedText('Experience')),
          const Tab(child: TranslatedText('Job Offers')),
          const Tab(child: TranslatedText('My Applications')),
        ];
      case 'business':
        return [
          const Tab(child: TranslatedText('About')),
          const Tab(child: TranslatedText('Job Vacancies')),
          const Tab(child: TranslatedText('Job Invites')),
          const Tab(child: TranslatedText('Job Applications')),
        ];
      case 'professional':
        return [
          const Tab(child: TranslatedText('About')),
          const Tab(child: TranslatedText('Works')),
          const Tab(child: TranslatedText('Connections')),
        ];
      default:
        return [const Tab(child: TranslatedText('About'))];
    }
  }

  List<Widget> _buildTabViews() {
    switch (widget.profile) {
      case 'employee':
        return [
          _buildAboutTab(),
          RefreshIndicator(
            onRefresh: _handleRefresh,
            child: const AchievementsList(showDeleteButtons: true),
          ),
          RefreshIndicator(
            onRefresh: _handleRefresh,
            child: const ExperienceList(showDeleteButtons: true),
          ),
          _buildJobOffersTab(),
          _buildEmployeeJobApplicationsTab(),
        ];
      case 'business':
        return [
          _buildAboutTab(),
          JobVacanciesTab(businessId: widget.userData?['id'] ?? ''),
          _buildJobInvitesTab(),
          _buildJobApplicationsTab(),
        ];
      case 'professional':
        return [
          _buildAboutTab(),
          RefreshIndicator(
            onRefresh: _handleRefresh,
            child: const WorksList(showDeleteButtons: true),
          ),
          _buildConnectionRequestsTab(),
        ];
      default:
        return [_buildAboutTab()];
    }
  }

  Widget _buildAboutTab() {
    final displayData = _getDisplayData();

    return RefreshIndicator(
      onRefresh: _handleRefresh,
      child: SingleChildScrollView(
        physics: const AlwaysScrollableScrollPhysics(),
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                TranslatedText(
                  'About',
                  style: TextStyle(
                    fontSize: 20,
                    fontWeight: FontWeight.bold,
                    color: Theme.of(context).colorScheme.onSurface,
                  ),
                ),
                IconButton(
                  icon: const Icon(Icons.refresh),
                  onPressed: _handleRefresh,
                ),
              ],
            ),
            const SizedBox(height: 16),
            Text(
              _getAboutText(displayData),
              style: TextStyle(
                fontSize: 16,
                color: Theme.of(context).colorScheme.onSurface.withOpacity(0.8),
                height: 1.5,
              ),
            ),
            const SizedBox(height: 24),

            // Skills section - prioritize employee profile data
            if (widget.profile == 'employee' &&
                _employeeProfileData != null &&
                _employeeProfileData!['skills']?.isNotEmpty == true) ...[
              TranslatedText(
                'Skills',
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                  color: Theme.of(context).colorScheme.onSurface,
                ),
              ),
              const SizedBox(height: 12),
              Wrap(
                spacing: 8,
                runSpacing: 8,
                children: (_employeeProfileData!['skills'] as List)
                    .map(
                      (skill) => Chip(
                        label: Text(skill['skill_name'] ?? skill.toString()),
                        backgroundColor: Colors.blue.withOpacity(0.1),
                        labelStyle: TextStyle(
                          color: Theme.of(context).colorScheme.primary,
                          fontWeight: FontWeight.w500,
                        ),
                      ),
                    )
                    .toList(),
              ),
              const SizedBox(height: 24),
            ] else if (displayData['skills'] != null &&
                (displayData['skills'] as List).isNotEmpty) ...[
              TranslatedText(
                'Skills',
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                  color: Theme.of(context).colorScheme.onSurface,
                ),
              ),
              const SizedBox(height: 12),
              Wrap(
                spacing: 8,
                runSpacing: 8,
                children: (displayData['skills'] as List)
                    .map(
                      (skill) => Chip(
                        label: Text(
                          skill is Map
                              ? skill['skill_name'] ?? skill.toString()
                              : skill.toString(),
                        ),
                        backgroundColor: Colors.blue.withOpacity(0.1),
                        labelStyle: TextStyle(
                          color: Theme.of(context).colorScheme.primary,
                          fontWeight: FontWeight.w500,
                        ),
                      ),
                    )
                    .toList(),
              ),
              const SizedBox(height: 24),
            ],
            if (widget.userData?['categories'] != null) ...[
              Text(
                'Categories',
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                  color: Theme.of(context).colorScheme.onSurface,
                ),
              ),
              const SizedBox(height: 12),
              Wrap(
                spacing: 8,
                runSpacing: 8,
                children: (widget.userData!['categories'] as List)
                    .map(
                      (category) => Chip(
                        label: Text(category),
                        backgroundColor: Theme.of(
                          context,
                        ).colorScheme.primaryContainer,
                      ),
                    )
                    .toList(),
              ),
              const SizedBox(height: 24),
            ],
            const SizedBox(height: 100), // Extra padding for FAB
          ],
        ),
      ),
    );
  }

  // Achievement tab is now handled by AchievementsList component

  // Achievement card is now handled by AchievementCard component

  Widget _buildJobOffersTab() {
    return RefreshIndicator(
      onRefresh: _handleRefresh,
      child: SingleChildScrollView(
        physics: const AlwaysScrollableScrollPhysics(),
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Text(
                  'Job Offers',
                  style: TextStyle(
                    fontSize: 20,
                    fontWeight: FontWeight.bold,
                    color: Theme.of(context).colorScheme.onSurface,
                  ),
                ),
                IconButton(
                  icon: const Icon(Icons.refresh),
                  onPressed: _handleRefresh,
                ),
              ],
            ),
            const SizedBox(height: 16),
            _buildJobOffersList(),
            const SizedBox(height: 100), // Extra padding for FAB
          ],
        ),
      ),
    );
  }

  Widget _buildJobInvitesTab() {
    return RefreshIndicator(
      onRefresh: _handleRefresh,
      child: SingleChildScrollView(
        physics: const AlwaysScrollableScrollPhysics(),
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Text(
                  'Job Invites',
                  style: TextStyle(
                    fontSize: 20,
                    fontWeight: FontWeight.bold,
                    color: Theme.of(context).colorScheme.onSurface,
                  ),
                ),
                IconButton(
                  icon: const Icon(Icons.refresh),
                  onPressed: _handleRefresh,
                ),
              ],
            ),
            const SizedBox(height: 16),
            _buildJobInvitesList(),
            const SizedBox(height: 100), // Extra padding for FAB
          ],
        ),
      ),
    );
  }

  Widget _buildJobApplicationsTab() {
    return RefreshIndicator(
      onRefresh: _handleRefresh,
      child: SingleChildScrollView(
        physics: const AlwaysScrollableScrollPhysics(),
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Text(
                  'Job Applications',
                  style: TextStyle(
                    fontSize: 20,
                    fontWeight: FontWeight.bold,
                    color: Theme.of(context).colorScheme.onSurface,
                  ),
                ),
                IconButton(
                  icon: const Icon(Icons.refresh),
                  onPressed: _handleRefresh,
                ),
              ],
            ),
            const SizedBox(height: 16),
            _buildJobApplicationsList(),
            const SizedBox(height: 100), // Extra padding for FAB
          ],
        ),
      ),
    );
  }

  Widget _buildConnectionRequestsTab() {
    return RefreshIndicator(
      onRefresh: _handleRefresh,
      child: SingleChildScrollView(
        physics: const AlwaysScrollableScrollPhysics(),
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      'Connections',
                      style: TextStyle(
                        fontSize: 20,
                        fontWeight: FontWeight.bold,
                        color: Theme.of(context).colorScheme.onSurface,
                      ),
                    ),
                    if (_connectionsMetadata != null)
                      Text(
                        '${_connectionsMetadata!['count']} total connections',
                        style: TextStyle(
                          fontSize: 14,
                          color: Theme.of(
                            context,
                          ).colorScheme.onSurface.withOpacity(0.6),
                        ),
                      ),
                  ],
                ),
                IconButton(
                  icon: const Icon(Icons.refresh),
                  onPressed: _handleRefresh,
                ),
              ],
            ),
            const SizedBox(height: 16),
            _buildConnectionRequestsList(),
            const SizedBox(height: 100), // Extra padding for FAB
          ],
        ),
      ),
    );
  }

  Widget _buildJobOffersList() {
    // Show loading state
    if (_isLoadingEmployeeJobOfferings) {
      return const Center(
        child: Padding(
          padding: EdgeInsets.all(32.0),
          child: CircularProgressIndicator(),
        ),
      );
    }

    // Show error state
    if (_employeeJobOfferingsError != null) {
      return Center(
        child: Padding(
          padding: const EdgeInsets.all(32.0),
          child: Column(
            children: [
              Icon(
                Icons.error_outline,
                size: 64,
                color: Theme.of(context).colorScheme.error,
              ),
              const SizedBox(height: 16),
              Text(
                'Error loading job offerings',
                style: Theme.of(context).textTheme.titleLarge?.copyWith(
                  color: Theme.of(context).colorScheme.error,
                ),
              ),
              const SizedBox(height: 8),
              Text(
                _employeeJobOfferingsError!,
                style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                  color: Theme.of(
                    context,
                  ).colorScheme.onSurface.withOpacity(0.7),
                ),
                textAlign: TextAlign.center,
              ),
              const SizedBox(height: 16),
              ElevatedButton(
                onPressed: _fetchEmployeeJobOfferings,
                child: const Text('Retry'),
              ),
            ],
          ),
        ),
      );
    }

    // Show empty state
    if (_employeeJobOfferings.isEmpty) {
      return _buildEmptyState(
        icon: Icons.work_outline,
        title: 'No Job Offers Yet',
        subtitle:
            'Job offers from companies will appear here when they find your profile interesting.',
      );
    }

    // Show job offerings list
    return ListView.builder(
      shrinkWrap: true,
      physics: const NeverScrollableScrollPhysics(),
      itemCount: _employeeJobOfferings.length,
      itemBuilder: (context, index) {
        final offering = _employeeJobOfferings[index];
        return _buildJobOfferingCard(offering);
      },
    );
  }

  Widget _buildJobInvitesList() {
    // Show loading state
    if (_isLoadingBusinessJobInvites) {
      return const Center(
        child: Padding(
          padding: EdgeInsets.all(32.0),
          child: CircularProgressIndicator(),
        ),
      );
    }

    // Show error state
    if (_businessJobInvitesError != null) {
      return Center(
        child: Padding(
          padding: const EdgeInsets.all(32.0),
          child: Column(
            children: [
              Icon(
                Icons.error_outline,
                size: 64,
                color: Theme.of(context).colorScheme.error,
              ),
              const SizedBox(height: 16),
              Text(
                'Error loading job invites',
                style: Theme.of(context).textTheme.titleLarge?.copyWith(
                  color: Theme.of(context).colorScheme.error,
                ),
              ),
              const SizedBox(height: 8),
              Text(
                _businessJobInvitesError!,
                style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                  color: Theme.of(
                    context,
                  ).colorScheme.onSurface.withOpacity(0.7),
                ),
                textAlign: TextAlign.center,
              ),
              const SizedBox(height: 16),
              ElevatedButton(
                onPressed: _fetchBusinessJobInvites,
                child: const Text('Retry'),
              ),
            ],
          ),
        ),
      );
    }

    // Show empty state
    if (_businessJobInvites.isEmpty) {
      return _buildEmptyState(
        icon: Icons.person_search,
        title: 'No Job Invites',
        subtitle:
            'Job invites sent to candidates will appear here when you invite professionals to apply.',
      );
    }

    // Show job invites list
    return ListView.builder(
      shrinkWrap: true,
      physics: const NeverScrollableScrollPhysics(),
      itemCount: _businessJobInvites.length,
      itemBuilder: (context, index) {
        final invite = _businessJobInvites[index];
        return _buildJobInviteCard(invite);
      },
    );
  }

  Widget _buildJobApplicationsList() {
    // Show loading state
    if (_isLoadingBusinessJobApplications) {
      return const Center(
        child: Padding(
          padding: EdgeInsets.all(32.0),
          child: CircularProgressIndicator(),
        ),
      );
    }

    // Show error state
    if (_businessJobApplicationsError != null) {
      return Center(
        child: Padding(
          padding: const EdgeInsets.all(32.0),
          child: Column(
            children: [
              Icon(
                Icons.error_outline,
                size: 64,
                color: Theme.of(context).colorScheme.error,
              ),
              const SizedBox(height: 16),
              Text(
                'Error loading job applications',
                style: Theme.of(context).textTheme.titleLarge?.copyWith(
                  color: Theme.of(context).colorScheme.error,
                ),
              ),
              const SizedBox(height: 8),
              Text(
                _businessJobApplicationsError!,
                style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                  color: Theme.of(
                    context,
                  ).colorScheme.onSurface.withOpacity(0.7),
                ),
                textAlign: TextAlign.center,
              ),
              const SizedBox(height: 16),
              ElevatedButton(
                onPressed: _fetchBusinessJobApplications,
                child: const Text('Retry'),
              ),
            ],
          ),
        ),
      );
    }

    // Show empty state
    if (_businessJobApplications.isEmpty) {
      return _buildEmptyState(
        icon: Icons.assignment,
        title: 'No Job Applications',
        subtitle:
            'Job applications from candidates will appear here when they apply to your job postings.',
      );
    }

    // Show job applications list
    return ListView.builder(
      shrinkWrap: true,
      physics: const NeverScrollableScrollPhysics(),
      itemCount: _businessJobApplications.length,
      itemBuilder: (context, index) {
        final application = _businessJobApplications[index];
        return _buildJobApplicationCard(application);
      },
    );
  }

  Widget _buildConnectionRequestsList() {
    // Show loading state
    if (_isLoadingProfessionalConnections) {
      return const Center(
        child: Padding(
          padding: EdgeInsets.all(32.0),
          child: CircularProgressIndicator(),
        ),
      );
    }

    // Show error state
    if (_professionalConnectionsError != null) {
      return Center(
        child: Padding(
          padding: const EdgeInsets.all(32.0),
          child: Column(
            children: [
              Icon(
                Icons.error_outline,
                size: 64,
                color: Theme.of(context).colorScheme.error,
              ),
              const SizedBox(height: 16),
              Text(
                'Error loading connections',
                style: Theme.of(context).textTheme.titleLarge?.copyWith(
                  color: Theme.of(context).colorScheme.error,
                ),
              ),
              const SizedBox(height: 8),
              Text(
                _professionalConnectionsError!,
                style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                  color: Theme.of(
                    context,
                  ).colorScheme.onSurface.withOpacity(0.7),
                ),
                textAlign: TextAlign.center,
              ),
              const SizedBox(height: 16),
              ElevatedButton(
                onPressed: _fetchProfessionalConnections,
                child: const Text('Retry'),
              ),
            ],
          ),
        ),
      );
    }

    // Show empty state
    if (_professionalConnections.isEmpty) {
      return _buildEmptyState(
        icon: Icons.people_outline,
        title: 'No Connections Yet',
        subtitle:
            'Your professional connections will appear here when you connect with other professionals.',
      );
    }

    // Show connections list
    return ListView.builder(
      shrinkWrap: true,
      physics: const NeverScrollableScrollPhysics(),
      itemCount: _professionalConnections.length,
      itemBuilder: (context, index) {
        final connection = _professionalConnections[index];
        return _buildConnectionCard(connection);
      },
    );
  }

  Widget _buildEmptyState({
    required IconData icon,
    required String title,
    required String subtitle,
  }) {
    return Center(
      child: Padding(
        padding: const EdgeInsets.all(32),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(
              icon,
              size: 80,
              color: Theme.of(context).colorScheme.onSurface.withOpacity(0.4),
            ),
            const SizedBox(height: 24),
            Text(
              title,
              style: Theme.of(context).textTheme.headlineSmall?.copyWith(
                fontWeight: FontWeight.bold,
                color: Theme.of(context).colorScheme.onSurface,
              ),
            ),
            const SizedBox(height: 8),
            Text(
              subtitle,
              style: Theme.of(context).textTheme.bodyLarge?.copyWith(
                color: Theme.of(context).colorScheme.onSurface.withOpacity(0.7),
              ),
              textAlign: TextAlign.center,
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildJobOfferingCard(Map<String, dynamic> offering) {
    final theme = Theme.of(context);
    final otherParty = offering['other_party'] as Map<String, dynamic>? ?? {};
    final jobVacancyDetails =
        offering['job_vacancy_details'] as Map<String, dynamic>? ?? {};
    final isAccepted = offering['is_accepted'] as bool? ?? false;
    final offeringType = offering['offering_type'] as String? ?? '';
    final createdAt = offering['created_at'] as int? ?? 0;

    // Format timestamp to readable date
    final date = createdAt > 0
        ? DateTime.fromMillisecondsSinceEpoch(createdAt * 1000)
        : DateTime.now();
    final formattedDate = _formatDate(date);

    // Format salary range
    final minSalary = jobVacancyDetails['min_salary'] as int? ?? 0;
    final maxSalary = jobVacancyDetails['max_salary'] as int? ?? 0;
    final salaryRange = minSalary > 0 && maxSalary > 0
        ? '‚Çπ${minSalary.toString().replaceAllMapped(RegExp(r'(\d{1,3})(?=(\d{3})+(?!\d))'), (Match m) => '${m[1]},')} - ‚Çπ${maxSalary.toString().replaceAllMapped(RegExp(r'(\d{1,3})(?=(\d{3})+(?!\d))'), (Match m) => '${m[1]},')}'
        : 'Salary not specified';

    return Container(
      margin: const EdgeInsets.only(bottom: 16),
      decoration: BoxDecoration(
        color: theme.colorScheme.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: theme.colorScheme.outline.withOpacity(0.2)),
        boxShadow: [
          BoxShadow(
            color: theme.colorScheme.shadow.withOpacity(0.1),
            blurRadius: 8,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: Padding(
        padding: const EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                // Company logo placeholder (since API doesn't provide logo URL)
                Container(
                  width: 50,
                  height: 50,
                  decoration: BoxDecoration(
                    color: theme.colorScheme.primaryContainer,
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Icon(
                    Icons.business,
                    color: theme.colorScheme.onPrimaryContainer,
                    size: 24,
                  ),
                ),
                const SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        jobVacancyDetails['job_title'] as String? ??
                            'Job Title',
                        style: theme.textTheme.titleMedium?.copyWith(
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                      Text(
                        otherParty['name'] as String? ?? 'Company Name',
                        style: theme.textTheme.bodyMedium?.copyWith(
                          color: theme.colorScheme.primary,
                        ),
                      ),
                      Text(
                        '$offeringType ‚Ä¢ $formattedDate',
                        style: theme.textTheme.bodySmall?.copyWith(
                          color: theme.colorScheme.onSurface.withOpacity(0.6),
                        ),
                      ),
                    ],
                  ),
                ),
                _buildJobOfferingStatusChip(isAccepted),
              ],
            ),
            const SizedBox(height: 16),
            Text(
              jobVacancyDetails['job_description'] as String? ??
                  'No description available',
              style: theme.textTheme.bodyMedium?.copyWith(
                color: theme.colorScheme.onSurface.withOpacity(0.7),
              ),
              maxLines: 2,
              overflow: TextOverflow.ellipsis,
            ),
            const SizedBox(height: 16),
            Wrap(
              spacing: 8,
              runSpacing: 4,
              children: [
                Row(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Icon(
                      Icons.currency_rupee,
                      size: 16,
                      color: theme.colorScheme.primary,
                    ),
                    const SizedBox(width: 4),
                    Flexible(
                      child: Text(
                        salaryRange,
                        style: theme.textTheme.bodySmall,
                        overflow: TextOverflow.ellipsis,
                      ),
                    ),
                  ],
                ),
                Row(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Icon(
                      Icons.location_on,
                      size: 16,
                      color: theme.colorScheme.primary,
                    ),
                    const SizedBox(width: 4),
                    Flexible(
                      child: Text(
                        jobVacancyDetails['job_location'] as String? ??
                            'Location not specified',
                        style: theme.textTheme.bodySmall,
                        overflow: TextOverflow.ellipsis,
                      ),
                    ),
                  ],
                ),
                Row(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Icon(
                      Icons.schedule,
                      size: 16,
                      color: theme.colorScheme.primary,
                    ),
                    const SizedBox(width: 4),
                    Text(
                      _formatJobType(
                        jobVacancyDetails['job_type'] as String? ?? '',
                      ),
                      style: theme.textTheme.bodySmall,
                    ),
                  ],
                ),
              ],
            ),
            const SizedBox(height: 16),
            Row(
              children: [
                Expanded(
                  child: OutlinedButton(
                    onPressed: () {
                      _showJobOfferDetails(offering);
                    },
                    child: const Text('View Details'),
                  ),
                ),
                const SizedBox(width: 12),
                Expanded(
                  child: ElevatedButton(
                    onPressed: isAccepted
                        ? () {
                            _openChatWithBusiness(offering);
                          }
                        : () {
                            _acceptJobOffer(offering);
                          },
                    child: Text(isAccepted ? 'Chat' : 'Accept'),
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildJobInviteCard(Map<String, dynamic> invite) {
    final theme = Theme.of(context);
    final employeeDetails =
        invite['employee_details'] as Map<String, dynamic>? ?? {};
    final jobVacancyDetails =
        invite['job_vacancy_details'] as Map<String, dynamic>? ?? {};
    final isAccepted = invite['is_accepted'] as bool? ?? false;
    final isActive = invite['is_active'] as bool? ?? true;
    final createdAt = invite['created_at'] as int? ?? 0;

    // Format timestamp to readable date
    final date = createdAt > 0
        ? DateTime.fromMillisecondsSinceEpoch(createdAt * 1000)
        : DateTime.now();
    final formattedDate = _formatDate(date);

    // Format salary range
    final minSalary = jobVacancyDetails['min_salary'] as int? ?? 0;
    final maxSalary = jobVacancyDetails['max_salary'] as int? ?? 0;
    final salaryRange = minSalary > 0 && maxSalary > 0
        ? '‚Çπ${minSalary.toString().replaceAllMapped(RegExp(r'(\d{1,3})(?=(\d{3})+(?!\d))'), (Match m) => '${m[1]},')} - ‚Çπ${maxSalary.toString().replaceAllMapped(RegExp(r'(\d{1,3})(?=(\d{3})+(?!\d))'), (Match m) => '${m[1]},')}'
        : 'Salary not specified';

    return Container(
      margin: const EdgeInsets.only(bottom: 16),
      decoration: BoxDecoration(
        color: theme.colorScheme.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: theme.colorScheme.outline.withOpacity(0.2)),
        boxShadow: [
          BoxShadow(
            color: theme.colorScheme.shadow.withOpacity(0.1),
            blurRadius: 8,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: Padding(
        padding: const EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                ClipRRect(
                  borderRadius: BorderRadius.circular(25),
                  child: CustomCachedNetworkImage(
                    imgUrl: employeeDetails['img_url'] ?? '',
                    width: 50,
                    height: 50,
                    borderRadius: 25,
                    fit: BoxFit.cover,
                    errorWidget: Container(
                      width: 50,
                      height: 50,
                      color: theme.colorScheme.primaryContainer,
                      child: Icon(
                        Icons.person,
                        color: theme.colorScheme.onPrimaryContainer,
                      ),
                    ),
                    placeholderColor: theme.colorScheme.primary,
                  ),
                ),
                const SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        '${employeeDetails['first_name'] ?? ''} ${employeeDetails['last_name'] ?? ''}'
                            .trim(),
                        style: theme.textTheme.titleMedium?.copyWith(
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                      Text(
                        'Invited for ${jobVacancyDetails['job_title'] ?? 'Position'}',
                        style: theme.textTheme.bodyMedium?.copyWith(
                          color: theme.colorScheme.primary,
                        ),
                      ),
                      Text(
                        formattedDate,
                        style: theme.textTheme.bodySmall?.copyWith(
                          color: theme.colorScheme.onSurface.withOpacity(0.6),
                        ),
                      ),
                    ],
                  ),
                ),
                _buildStatusChip(
                  !isActive
                      ? 'withdrawn'
                      : (isAccepted ? 'accepted' : 'pending'),
                ),
              ],
            ),
            const SizedBox(height: 16),
            Text(
              jobVacancyDetails['job_description'] ??
                  'No description available',
              style: theme.textTheme.bodyMedium,
              maxLines: 2,
              overflow: TextOverflow.ellipsis,
            ),
            const SizedBox(height: 12),
            Wrap(
              spacing: 8,
              runSpacing: 4,
              children: [
                Row(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Icon(
                      Icons.location_on,
                      size: 16,
                      color: theme.colorScheme.primary,
                    ),
                    const SizedBox(width: 4),
                    Text(
                      jobVacancyDetails['job_location'] ??
                          'Location not specified',
                      style: theme.textTheme.bodySmall,
                    ),
                  ],
                ),
                Row(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Icon(
                      Icons.currency_rupee,
                      size: 16,
                      color: theme.colorScheme.primary,
                    ),
                    const SizedBox(width: 4),
                    Text(salaryRange, style: theme.textTheme.bodySmall),
                  ],
                ),
              ],
            ),
            const SizedBox(height: 16),
            Row(
              children: [
                Expanded(
                  child: OutlinedButton(
                    onPressed: () {
                      _showJobInviteDetails(invite);
                    },
                    child: const Text('View Details'),
                  ),
                ),
                const SizedBox(width: 12),
                Expanded(
                  child: ElevatedButton(
                    onPressed: !isActive
                        ? null
                        : isAccepted
                        ? () {
                            _openChatWithEmployee(invite);
                          }
                        : () {
                            _withdrawJobInvite(invite);
                          },
                    child: Text(
                      !isActive
                          ? 'Withdrawn'
                          : (isAccepted ? 'Chat' : 'Withdraw'),
                    ),
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildJobApplicationCard(Map<String, dynamic> application) {
    final theme = Theme.of(context);
    final employeeDetails =
        application['employee_details'] as Map<String, dynamic>? ?? {};
    final jobVacancyDetails =
        application['job_vacancy_details'] as Map<String, dynamic>? ?? {};
    final applicationStatus =
        application['application_status'] as String? ?? 'pending';
    final createdAt = application['created_at'] as int? ?? 0;

    // Extract employee data (excluding phone and email as requested)
    final firstName = employeeDetails['first_name'] as String? ?? '';
    final lastName = employeeDetails['last_name'] as String? ?? '';
    final candidateName = '$firstName $lastName'.trim();
    final candidateBio =
        employeeDetails['bio'] as String? ?? 'No bio available';
    final candidateImage = employeeDetails['img_url'] as String?;
    final candidateCity = employeeDetails['city'] as String? ?? '';
    final candidateState = employeeDetails['state'] as String? ?? '';
    final candidateCountry = employeeDetails['country'] as String? ?? '';
    final experienceYears = employeeDetails['experience_years'] as int? ?? 0;
    final skills = employeeDetails['skills'] as List? ?? [];

    // Extract job details
    final jobTitle = jobVacancyDetails['job_title'] as String? ?? 'Position';
    final jobLocation = jobVacancyDetails['job_location'] as String? ?? '';
    final minSalary = jobVacancyDetails['min_salary'] as int? ?? 0;
    final maxSalary = jobVacancyDetails['max_salary'] as int? ?? 0;

    // Format data
    final applicationDate = createdAt > 0
        ? _formatDate(DateTime.fromMillisecondsSinceEpoch(createdAt * 1000))
        : 'Unknown date';

    final location = [
      candidateCity,
      candidateState,
      candidateCountry,
    ].where((s) => s.isNotEmpty).join(', ');

    final salaryRange = minSalary > 0 && maxSalary > 0
        ? '‚Çπ${_formatNumber(minSalary)} - ‚Çπ${_formatNumber(maxSalary)}'
        : 'Salary not specified';

    return Container(
      margin: const EdgeInsets.only(bottom: 16),
      decoration: BoxDecoration(
        color: theme.colorScheme.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: theme.colorScheme.outline.withOpacity(0.2)),
        boxShadow: [
          BoxShadow(
            color: theme.colorScheme.shadow.withOpacity(0.1),
            blurRadius: 8,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: Padding(
        padding: const EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                // Employee avatar
                ClipRRect(
                  borderRadius: BorderRadius.circular(25),
                  child: CustomCachedNetworkImage(
                    imgUrl: candidateImage ?? '',
                    width: 50,
                    height: 50,
                    borderRadius: 25,
                    fit: BoxFit.cover,
                    errorWidget: Container(
                      width: 50,
                      height: 50,
                      color: theme.colorScheme.primaryContainer,
                      child: Icon(
                        Icons.person,
                        color: theme.colorScheme.onPrimaryContainer,
                      ),
                    ),
                    placeholderColor: theme.colorScheme.primary,
                  ),
                ),
                const SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        candidateName.isNotEmpty
                            ? candidateName
                            : 'Unknown Candidate',
                        style: theme.textTheme.titleMedium?.copyWith(
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                      Text(
                        'Applied for $jobTitle',
                        style: theme.textTheme.bodyMedium?.copyWith(
                          color: theme.colorScheme.primary,
                        ),
                      ),
                      if (location.isNotEmpty)
                        Text(
                          location,
                          style: theme.textTheme.bodySmall?.copyWith(
                            color: theme.colorScheme.onSurface.withOpacity(0.6),
                          ),
                        ),
                      Text(
                        applicationDate,
                        style: theme.textTheme.bodySmall?.copyWith(
                          color: theme.colorScheme.onSurface.withOpacity(0.6),
                        ),
                      ),
                    ],
                  ),
                ),
                _buildStatusChip(applicationStatus),
              ],
            ),
            const SizedBox(height: 16),

            // Experience and job details
            Wrap(
              spacing: 8,
              runSpacing: 4,
              children: [
                if (experienceYears > 0)
                  Row(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      Icon(
                        Icons.work,
                        size: 16,
                        color: theme.colorScheme.primary,
                      ),
                      const SizedBox(width: 4),
                      Text(
                        '$experienceYears years experience',
                        style: theme.textTheme.bodySmall,
                      ),
                    ],
                  ),
                Row(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Icon(
                      Icons.currency_rupee,
                      size: 16,
                      color: theme.colorScheme.primary,
                    ),
                    const SizedBox(width: 4),
                    Text(salaryRange, style: theme.textTheme.bodySmall),
                  ],
                ),
                if (jobLocation.isNotEmpty)
                  Row(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      Icon(
                        Icons.location_on,
                        size: 16,
                        color: theme.colorScheme.primary,
                      ),
                      const SizedBox(width: 4),
                      Text(jobLocation, style: theme.textTheme.bodySmall),
                    ],
                  ),
              ],
            ),

            // Bio
            if (candidateBio.isNotEmpty &&
                candidateBio != 'No bio available') ...[
              const SizedBox(height: 12),
              Text(
                candidateBio,
                style: theme.textTheme.bodyMedium?.copyWith(
                  color: theme.colorScheme.onSurface.withOpacity(0.8),
                ),
                maxLines: 2,
                overflow: TextOverflow.ellipsis,
              ),
            ],

            // Skills
            if (skills.isNotEmpty) ...[
              const SizedBox(height: 12),
              Wrap(
                spacing: 8,
                runSpacing: 4,
                children: skills.take(4).map((skill) {
                  final skillName = skill is Map
                      ? skill['skill_name'] ?? skill.toString()
                      : skill.toString();
                  return Chip(
                    label: Text(
                      skillName,
                      style: const TextStyle(fontSize: 12),
                    ),
                    backgroundColor: theme.colorScheme.primaryContainer,
                    visualDensity: VisualDensity.compact,
                  );
                }).toList(),
              ),
              if (skills.length > 4)
                Padding(
                  padding: const EdgeInsets.only(top: 4),
                  child: Text(
                    '+${skills.length - 4} more skills',
                    style: theme.textTheme.bodySmall?.copyWith(
                      color: theme.colorScheme.onSurface.withOpacity(0.6),
                    ),
                  ),
                ),
            ],

            const SizedBox(height: 16),
            Row(
              children: [
                Expanded(
                  child: OutlinedButton(
                    onPressed: () => _showJobApplicationDetails(application),
                    child: const Text('View Details'),
                  ),
                ),
                const SizedBox(width: 12),
                Expanded(child: _buildApplicationActionButton(application)),
              ],
            ),
          ],
        ),
      ),
    );
  }

  Future<void> _fetchEmployeeJobApplications() async {
    print(
      'üìã UserProfileEditableScreen: Fetching employee job applications...',
    );

    try {
      setState(() {
        _isLoadingEmployeeJobApplications = true;
        _employeeJobApplicationsError = null;
      });

      final response = await ApiService.post(
        '/get-my-jobapplications/',
        body: {},
        useBearerToken: true,
      );

      print(
        'üì° UserProfileEditableScreen: Employee job applications response:',
      );
      print(response);

      if (response['data'] != null && response['data']['status'] == 200) {
        final jobApplicationsData = response['data']['data'] as List? ?? [];
        final metadata = {
          'count': response['data']['count'] ?? 0,
          'pagination': response['data']['pagination'] ?? {},
          'access_info': response['data']['access_info'] ?? {},
        };

        print(
          '‚úÖ UserProfileEditableScreen: Employee job applications loaded successfully',
        );
        print('üìä Count: ${jobApplicationsData.length} applications');

        setState(() {
          _employeeJobApplications = jobApplicationsData
              .cast<Map<String, dynamic>>();
          _employeeJobApplicationsMetadata = metadata;
          _isLoadingEmployeeJobApplications = false;
        });
      } else {
        final errorMessage =
            response['data']?['message'] ?? 'Failed to load job applications';
        print(
          '‚ùå UserProfileEditableScreen: Error loading employee job applications: $errorMessage',
        );

        setState(() {
          _employeeJobApplicationsError = errorMessage;
          _isLoadingEmployeeJobApplications = false;
        });
      }
    } catch (e) {
      print(
        '‚ùå UserProfileEditableScreen: Employee job applications fetch error: $e',
      );
      setState(() {
        _employeeJobApplicationsError = 'Network error occurred';
        _isLoadingEmployeeJobApplications = false;
      });
    }
  }

  Widget _buildEmployeeJobApplicationsTab() {
    return RefreshIndicator(
      onRefresh: _handleRefresh,
      child: SingleChildScrollView(
        physics: const AlwaysScrollableScrollPhysics(),
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      'My Job Applications',
                      style: TextStyle(
                        fontSize: 20,
                        fontWeight: FontWeight.bold,
                        color: Theme.of(context).colorScheme.onSurface,
                      ),
                    ),
                    if (_employeeJobApplicationsMetadata != null)
                      Text(
                        '${_employeeJobApplicationsMetadata!['count']} total applications',
                        style: TextStyle(
                          fontSize: 14,
                          color: Theme.of(
                            context,
                          ).colorScheme.onSurface.withOpacity(0.6),
                        ),
                      ),
                  ],
                ),
                IconButton(
                  icon: const Icon(Icons.refresh),
                  onPressed: _fetchEmployeeJobApplications,
                ),
              ],
            ),
            const SizedBox(height: 16),
            _buildEmployeeJobApplicationsList(),
            const SizedBox(height: 100), // Extra padding for FAB
          ],
        ),
      ),
    );
  }

  Widget _buildEmployeeJobApplicationsList() {
    // Show loading state
    if (_isLoadingEmployeeJobApplications) {
      return const Center(
        child: Padding(
          padding: EdgeInsets.all(32.0),
          child: CircularProgressIndicator(),
        ),
      );
    }

    // Show error state
    if (_employeeJobApplicationsError != null) {
      return Center(
        child: Padding(
          padding: const EdgeInsets.all(32.0),
          child: Column(
            children: [
              Icon(
                Icons.error_outline,
                size: 64,
                color: Theme.of(context).colorScheme.error,
              ),
              const SizedBox(height: 16),
              Text(
                'Error loading job applications',
                style: Theme.of(context).textTheme.titleLarge?.copyWith(
                  color: Theme.of(context).colorScheme.error,
                ),
              ),
              const SizedBox(height: 8),
              Text(
                _employeeJobApplicationsError!,
                style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                  color: Theme.of(
                    context,
                  ).colorScheme.onSurface.withOpacity(0.7),
                ),
                textAlign: TextAlign.center,
              ),
              const SizedBox(height: 16),
              ElevatedButton(
                onPressed: _fetchEmployeeJobApplications,
                child: const Text('Retry'),
              ),
            ],
          ),
        ),
      );
    }

    // Show empty state
    if (_employeeJobApplications.isEmpty) {
      return _buildEmptyState(
        icon: Icons.assignment,
        title: 'No Job Applications',
        subtitle:
            'You haven\'t applied to any jobs yet. Start exploring opportunities and apply to positions that match your skills.',
      );
    }

    // Show job applications list
    return ListView.builder(
      shrinkWrap: true,
      physics: const NeverScrollableScrollPhysics(),
      itemCount: _employeeJobApplications.length,
      itemBuilder: (context, index) {
        final application = _employeeJobApplications[index];
        return _buildEmployeeJobApplicationCard(application);
      },
    );
  }

  Widget _buildEmployeeJobApplicationCard(Map<String, dynamic> application) {
    final theme = Theme.of(context);
    final businessDetails =
        application['business_details'] as Map<String, dynamic>? ?? {};
    final jobVacancyDetails =
        application['job_vacancy_details'] as Map<String, dynamic>? ?? {};
    final applicationStatus =
        application['application_status'] as String? ?? 'pending';
    final isAccepted = application['is_accepted'] as bool? ?? false;
    final createdAt = application['created_at'] as int? ?? 0;

    // Extract business data (excluding phone and email as requested)
    final businessName =
        businessDetails['business_name'] as String? ?? 'Unknown Business';
    final businessImage = businessDetails['img_url'] as String?;
    final businessCity = businessDetails['city'] as String? ?? '';
    final businessState = businessDetails['state'] as String? ?? '';
    final businessCountry = businessDetails['country'] as String? ?? '';

    // Extract job details
    final jobTitle = jobVacancyDetails['job_title'] as String? ?? 'Position';
    final jobDescription =
        jobVacancyDetails['job_description'] as String? ?? '';
    final jobLocation = jobVacancyDetails['job_location'] as String? ?? '';
    final jobType = jobVacancyDetails['job_type'] as String? ?? '';
    final minSalary = jobVacancyDetails['min_salary'] as int? ?? 0;
    final maxSalary = jobVacancyDetails['max_salary'] as int? ?? 0;

    // Format data
    final applicationDate = createdAt > 0
        ? _formatDate(DateTime.fromMillisecondsSinceEpoch(createdAt * 1000))
        : 'Unknown date';

    final businessLocation = [
      businessCity,
      businessState,
      businessCountry,
    ].where((s) => s.isNotEmpty).join(', ');

    final salaryRange = minSalary > 0 && maxSalary > 0
        ? '‚Çπ${_formatNumber(minSalary)} - ‚Çπ${_formatNumber(maxSalary)}'
        : 'Salary not specified';

    return Container(
      margin: const EdgeInsets.only(bottom: 16),
      decoration: BoxDecoration(
        color: theme.colorScheme.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: theme.colorScheme.outline.withOpacity(0.2)),
        boxShadow: [
          BoxShadow(
            color: theme.colorScheme.shadow.withOpacity(0.1),
            blurRadius: 8,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: Padding(
        padding: const EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                // Business avatar
                ClipRRect(
                  borderRadius: BorderRadius.circular(25),
                  child: businessImage != null
                      ? Image.network(
                          businessImage,
                          width: 50,
                          height: 50,
                          fit: BoxFit.cover,
                          errorBuilder: (context, error, stackTrace) =>
                              Container(
                                width: 50,
                                height: 50,
                                color: theme.colorScheme.primaryContainer,
                                child: Icon(
                                  Icons.business,
                                  color: theme.colorScheme.onPrimaryContainer,
                                ),
                              ),
                        )
                      : Container(
                          width: 50,
                          height: 50,
                          color: theme.colorScheme.primaryContainer,
                          child: Icon(
                            Icons.business,
                            color: theme.colorScheme.onPrimaryContainer,
                          ),
                        ),
                ),
                const SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        jobTitle,
                        style: theme.textTheme.titleMedium?.copyWith(
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                      Text(
                        'at $businessName',
                        style: theme.textTheme.bodyMedium?.copyWith(
                          color: theme.colorScheme.primary,
                        ),
                      ),
                      if (businessLocation.isNotEmpty)
                        Text(
                          businessLocation,
                          style: theme.textTheme.bodySmall?.copyWith(
                            color: theme.colorScheme.onSurface.withOpacity(0.6),
                          ),
                        ),
                      Text(
                        'Applied on $applicationDate',
                        style: theme.textTheme.bodySmall?.copyWith(
                          color: theme.colorScheme.onSurface.withOpacity(0.6),
                        ),
                      ),
                    ],
                  ),
                ),
                _buildStatusChip(applicationStatus),
              ],
            ),
            const SizedBox(height: 16),

            // Job details
            Wrap(
              spacing: 8,
              runSpacing: 4,
              children: [
                Row(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Icon(
                      Icons.currency_rupee,
                      size: 16,
                      color: theme.colorScheme.primary,
                    ),
                    const SizedBox(width: 4),
                    Text(salaryRange, style: theme.textTheme.bodySmall),
                  ],
                ),
                if (jobLocation.isNotEmpty)
                  Row(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      Icon(
                        Icons.location_on,
                        size: 16,
                        color: theme.colorScheme.primary,
                      ),
                      const SizedBox(width: 4),
                      Text(jobLocation, style: theme.textTheme.bodySmall),
                    ],
                  ),
                if (jobType.isNotEmpty)
                  Row(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      Icon(
                        Icons.work,
                        size: 16,
                        color: theme.colorScheme.primary,
                      ),
                      const SizedBox(width: 4),
                      Text(
                        _formatJobType(jobType),
                        style: theme.textTheme.bodySmall,
                      ),
                    ],
                  ),
              ],
            ),

            // Job description
            if (jobDescription.isNotEmpty) ...[
              const SizedBox(height: 12),
              Text(
                jobDescription,
                style: theme.textTheme.bodyMedium?.copyWith(
                  color: theme.colorScheme.onSurface.withOpacity(0.8),
                ),
                maxLines: 2,
                overflow: TextOverflow.ellipsis,
              ),
            ],

            const SizedBox(height: 16),
            Row(
              children: [
                Expanded(
                  child: OutlinedButton(
                    onPressed: () =>
                        _showEmployeeJobApplicationDetails(application),
                    child: const Text('View Details'),
                  ),
                ),
                const SizedBox(width: 12),
                Expanded(
                  child: _buildEmployeeApplicationActionButton(application),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }

  /// Build action button for employee job application card
  Widget _buildEmployeeApplicationActionButton(
    Map<String, dynamic> application,
  ) {
    final applicationStatus =
        application['application_status'] as String? ?? 'pending';
    final isAccepted = application['is_accepted'] as bool? ?? false;

    if (isAccepted) {
      // Show Chat button only if is_accepted is true
      return ElevatedButton(
        onPressed: () => _openChatWithBusinessFromApplication(application),
        style: ElevatedButton.styleFrom(
          backgroundColor: Colors.blue,
          foregroundColor: Colors.white,
        ),
        child: const Text('Chat'),
      );
    } else if (applicationStatus == 'pending') {
      // Show Pending status for pending applications
      return ElevatedButton(onPressed: null, child: const Text('Pending'));
    } else {
      // Show status for other statuses
      return ElevatedButton(
        onPressed: null,
        child: Text(applicationStatus.toUpperCase()),
      );
    }
  }

  /// Open chat with business from job application
  void _openChatWithBusinessFromApplication(Map<String, dynamic> application) {
    final businessDetails =
        application['business_details'] as Map<String, dynamic>? ?? {};
    final businessId = businessDetails['id'];
    final businessName = businessDetails['business_name'] as String? ?? '';
    final contactImage = businessDetails['img_url'] as String?;

    if (businessId == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text(
            'Unable to start chat: Business information not available',
          ),
          backgroundColor: Colors.red,
        ),
      );
      return;
    }

    // Get current employee ID as sender
    final employeeId = _employeeProfileData?['id'];
    if (employeeId == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text(
            'Unable to start chat: Employee information not available',
          ),
          backgroundColor: Colors.red,
        ),
      );
      return;
    }

    // Navigate to chat screen
    Navigator.pushNamed(
      context,
      '/chat',
      arguments: {
        'userId': businessId,
        'senderId': employeeId,
        'receiverId': businessId,
        'contactName': businessName.isNotEmpty ? businessName : 'Business',
        'contactImage': contactImage,
      },
    );
  }

  /// Show employee job application details in a bottom sheet
  void _showEmployeeJobApplicationDetails(Map<String, dynamic> application) {
    final businessDetails =
        application['business_details'] as Map<String, dynamic>? ?? {};
    final jobVacancyDetails =
        application['job_vacancy_details'] as Map<String, dynamic>? ?? {};
    final applicationStatus =
        application['application_status'] as String? ?? 'pending';
    final createdAt = application['created_at'] as int? ?? 0;

    // Extract business data (excluding phone and email as requested)
    final businessName =
        businessDetails['business_name'] as String? ?? 'Unknown Business';
    final businessImage = businessDetails['img_url'] as String?;
    final businessCity = businessDetails['city'] as String? ?? '';
    final businessState = businessDetails['state'] as String? ?? '';
    final businessCountry = businessDetails['country'] as String? ?? '';

    // Extract job details
    final jobTitle = jobVacancyDetails['job_title'] as String? ?? 'Position';
    final jobDescription =
        jobVacancyDetails['job_description'] as String? ?? '';
    final jobLocation = jobVacancyDetails['job_location'] as String? ?? '';
    final jobType = jobVacancyDetails['job_type'] as String? ?? '';
    final jobStatus = jobVacancyDetails['job_status'] as String? ?? '';
    final minSalary = jobVacancyDetails['min_salary'] as int? ?? 0;
    final maxSalary = jobVacancyDetails['max_salary'] as int? ?? 0;
    final lastDateToApply =
        jobVacancyDetails['last_date_to_apply'] as int? ?? 0;

    final applicationDate = createdAt > 0
        ? _formatDate(DateTime.fromMillisecondsSinceEpoch(createdAt * 1000))
        : 'Unknown date';

    final businessLocation = [
      businessCity,
      businessState,
      businessCountry,
    ].where((s) => s.isNotEmpty).join(', ');

    final salaryRange = minSalary > 0 && maxSalary > 0
        ? '‚Çπ${_formatNumber(minSalary)} - ‚Çπ${_formatNumber(maxSalary)}'
        : 'Salary not specified';

    final lastDate = lastDateToApply > 0
        ? _formatDate(
            DateTime.fromMillisecondsSinceEpoch(lastDateToApply * 1000),
          )
        : 'Not specified';

    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => DraggableScrollableSheet(
        initialChildSize: 0.7,
        maxChildSize: 0.95,
        minChildSize: 0.5,
        builder: (context, scrollController) => Container(
          decoration: BoxDecoration(
            color: Theme.of(context).colorScheme.surface,
            borderRadius: const BorderRadius.vertical(top: Radius.circular(20)),
          ),
          child: Column(
            children: [
              // Handle bar
              Container(
                margin: const EdgeInsets.only(top: 8),
                width: 40,
                height: 4,
                decoration: BoxDecoration(
                  color: Theme.of(context).colorScheme.outline.withOpacity(0.3),
                  borderRadius: BorderRadius.circular(2),
                ),
              ),
              // Content
              Expanded(
                child: SingleChildScrollView(
                  controller: scrollController,
                  padding: const EdgeInsets.all(24),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      // Header
                      Row(
                        children: [
                          ClipRRect(
                            borderRadius: BorderRadius.circular(30),
                            child: businessImage != null
                                ? Image.network(
                                    businessImage,
                                    width: 60,
                                    height: 60,
                                    fit: BoxFit.cover,
                                    errorBuilder:
                                        (context, error, stackTrace) =>
                                            _buildDefaultBusinessAvatar(60),
                                  )
                                : _buildDefaultBusinessAvatar(60),
                          ),
                          const SizedBox(width: 16),
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  jobTitle,
                                  style: Theme.of(context)
                                      .textTheme
                                      .headlineSmall
                                      ?.copyWith(fontWeight: FontWeight.bold),
                                ),
                                Text(
                                  'at $businessName',
                                  style: Theme.of(context).textTheme.bodyLarge
                                      ?.copyWith(
                                        color: Theme.of(
                                          context,
                                        ).colorScheme.primary,
                                      ),
                                ),
                                if (businessLocation.isNotEmpty) ...[
                                  const SizedBox(height: 4),
                                  Row(
                                    children: [
                                      Icon(
                                        Icons.location_on,
                                        size: 16,
                                        color: Theme.of(
                                          context,
                                        ).colorScheme.primary,
                                      ),
                                      const SizedBox(width: 4),
                                      Flexible(
                                        child: Text(
                                          businessLocation,
                                          overflow: TextOverflow.ellipsis,
                                        ),
                                      ),
                                    ],
                                  ),
                                ],
                                const SizedBox(height: 4),
                                Text(
                                  'Applied on $applicationDate',
                                  style: Theme.of(context).textTheme.bodyMedium
                                      ?.copyWith(
                                        color: Theme.of(context)
                                            .colorScheme
                                            .onSurface
                                            .withOpacity(0.7),
                                      ),
                                ),
                              ],
                            ),
                          ),
                          _buildStatusChip(applicationStatus),
                        ],
                      ),

                      const SizedBox(height: 24),

                      // Job Information
                      _buildDetailSection('Job Information', [
                        _buildDetailRow('Position', jobTitle),
                        _buildDetailRow('Company', businessName),
                        _buildDetailRow('Location', jobLocation),
                        _buildDetailRow('Type', _formatJobType(jobType)),
                        _buildDetailRow('Status', jobStatus.toUpperCase()),
                        _buildDetailRow('Salary', salaryRange),
                        _buildDetailRow('Last Date to Apply', lastDate),
                      ]),

                      if (jobDescription.isNotEmpty) ...[
                        const SizedBox(height: 20),
                        _buildDetailSection('Job Description', [
                          Padding(
                            padding: const EdgeInsets.only(top: 8),
                            child: Text(
                              jobDescription,
                              style: Theme.of(context).textTheme.bodyMedium,
                            ),
                          ),
                        ]),
                      ],

                      // Application Information
                      const SizedBox(height: 20),
                      _buildDetailSection('Application Information', [
                        _buildDetailRow('Application Date', applicationDate),
                        _buildDetailRow(
                          'Application ID',
                          application['id'] ?? 'Unknown',
                        ),
                        _buildDetailRow(
                          'Status',
                          applicationStatus.toUpperCase(),
                        ),
                      ]),

                      const SizedBox(height: 40),

                      // Action buttons - Only Close button
                      SizedBox(
                        width: double.infinity,
                        child: ElevatedButton(
                          onPressed: () => Navigator.pop(context),
                          child: const Text('Close'),
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildDefaultBusinessAvatar(double size) {
    return Container(
      width: size,
      height: size,
      decoration: BoxDecoration(
        color: Theme.of(context).colorScheme.primaryContainer,
        borderRadius: BorderRadius.circular(size / 2),
      ),
      child: Icon(
        Icons.business,
        size: size * 0.6,
        color: Theme.of(context).colorScheme.onPrimaryContainer,
      ),
    );
  }

  /// Helper method to format numbers with commas
  String _formatNumber(int number) {
    return number.toString().replaceAllMapped(
      RegExp(r'(\d{1,3})(?=(\d{3})+(?!\d))'),
      (Match m) => '${m[1]},',
    );
  }

  /// Build action button for job application card
  Widget _buildApplicationActionButton(Map<String, dynamic> application) {
    final applicationStatus =
        application['application_status'] as String? ?? 'pending';
    final isAccepted = application['is_accepted'] as bool? ?? false;

    if (isAccepted || applicationStatus == 'active') {
      // Show Chat button if accepted
      return ElevatedButton(
        onPressed: () => _openChatWithEmployeeFromApplication(application),
        style: ElevatedButton.styleFrom(
          backgroundColor: Colors.blue,
          foregroundColor: Colors.white,
        ),
        child: const Text('Chat'),
      );
    } else if (applicationStatus == 'pending') {
      // Show Accept button if pending
      return ElevatedButton(
        onPressed: () => _acceptJobApplication(application),
        style: ElevatedButton.styleFrom(
          backgroundColor: Colors.green,
          foregroundColor: Colors.white,
        ),
        child: const Text('Accept'),
      );
    } else {
      // Show disabled state for other statuses
      return ElevatedButton(
        onPressed: null,
        child: Text(applicationStatus.toUpperCase()),
      );
    }
  }

  /// Accept job application
  Future<void> _acceptJobApplication(Map<String, dynamic> application) async {
    final applicationId = application['id'];
    if (applicationId == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Row(
            children: [
              const Icon(Icons.error, color: Colors.white, size: 16),
              const SizedBox(width: 8),
              const Expanded(child: Text('Invalid application ID')),
            ],
          ),
          backgroundColor: Colors.red,
          duration: const Duration(seconds: 3),
          behavior: SnackBarBehavior.floating,
          margin: const EdgeInsets.all(16),
          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
        ),
      );
      return;
    }

    // Show loading dialog
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => Dialog(
        child: IntrinsicHeight(
          child: Padding(
            padding: const EdgeInsets.all(24),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                const CircularProgressIndicator(),
                const SizedBox(height: 16),
                Text(
                  'Accepting application...',
                  style: Theme.of(context).textTheme.bodyLarge,
                ),
              ],
            ),
          ),
        ),
      ),
    );

    try {
      final response = await ApiService.put(
        '/accept-business-jobapplication/',
        body: {'application_id': applicationId},
        useBearerToken: true,
      );

      // Close loading dialog
      if (mounted) Navigator.pop(context);

      if (response['data'] != null && response['data']['status'] == 200) {
        // Show success message
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Row(
                children: [
                  const Icon(Icons.check_circle, color: Colors.white, size: 16),
                  const SizedBox(width: 8),
                  Expanded(
                    child: Text(
                      response['data']['message'] ??
                          'Application accepted successfully',
                    ),
                  ),
                ],
              ),
              backgroundColor: Colors.green,
              duration: const Duration(seconds: 3),
              behavior: SnackBarBehavior.floating,
              margin: const EdgeInsets.all(16),
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(8),
              ),
            ),
          );

          // Refresh the job applications list
          _fetchBusinessJobApplications();
        }
      } else {
        throw Exception(
          response['data']?['message'] ?? 'Failed to accept application',
        );
      }
    } catch (e) {
      // Close loading dialog if still open
      if (mounted) Navigator.pop(context);

      // Show error message
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Row(
              children: [
                const Icon(Icons.error, color: Colors.white, size: 16),
                const SizedBox(width: 8),
                Expanded(child: Text('Error: ${e.toString()}')),
              ],
            ),
            backgroundColor: Colors.red,
            duration: const Duration(seconds: 3),
            behavior: SnackBarBehavior.floating,
            margin: const EdgeInsets.all(16),
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(8),
            ),
          ),
        );
      }
    }
  }

  /// Open chat with employee from job application
  void _openChatWithEmployeeFromApplication(Map<String, dynamic> application) {
    final employeeDetails =
        application['employee_details'] as Map<String, dynamic>? ?? {};
    final employeeId = employeeDetails['id'];
    final firstName = employeeDetails['first_name'] as String? ?? '';
    final lastName = employeeDetails['last_name'] as String? ?? '';
    final contactName = '$firstName $lastName'.trim();
    final contactImage = employeeDetails['img_url'] as String?;

    if (employeeId == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text(
            'Unable to start chat: Employee information not available',
          ),
          backgroundColor: Colors.red,
        ),
      );
      return;
    }

    // Get current business ID as sender
    final businessId = widget.userData?['id'];
    if (businessId == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text(
            'Unable to start chat: Business information not available',
          ),
          backgroundColor: Colors.red,
        ),
      );
      return;
    }

    // Navigate to chat screen
    Navigator.pushNamed(
      context,
      '/chat',
      arguments: {
        'userId': employeeId,
        'senderId': businessId,
        'receiverId': employeeId,
        'contactName': contactName.isNotEmpty ? contactName : 'Employee',
        'contactImage': contactImage,
      },
    );
  }

  /// Show job application details in a bottom sheet
  void _showJobApplicationDetails(Map<String, dynamic> application) {
    final employeeDetails =
        application['employee_details'] as Map<String, dynamic>? ?? {};
    final jobVacancyDetails =
        application['job_vacancy_details'] as Map<String, dynamic>? ?? {};
    final applicationStatus =
        application['application_status'] as String? ?? 'pending';
    final createdAt = application['created_at'] as int? ?? 0;

    // Extract data
    final firstName = employeeDetails['first_name'] as String? ?? '';
    final lastName = employeeDetails['last_name'] as String? ?? '';
    final candidateName = '$firstName $lastName'.trim();
    final candidateBio = employeeDetails['bio'] as String? ?? '';
    final candidateImage = employeeDetails['img_url'] as String?;
    final candidateCity = employeeDetails['city'] as String? ?? '';
    final candidateState = employeeDetails['state'] as String? ?? '';
    final candidateCountry = employeeDetails['country'] as String? ?? '';
    final experienceYears = employeeDetails['experience_years'] as int? ?? 0;
    final skills = employeeDetails['skills'] as List? ?? [];

    final jobTitle = jobVacancyDetails['job_title'] as String? ?? 'Position';
    final jobDescription =
        jobVacancyDetails['job_description'] as String? ?? '';
    final jobLocation = jobVacancyDetails['job_location'] as String? ?? '';
    final jobType = jobVacancyDetails['job_type'] as String? ?? '';
    final minSalary = jobVacancyDetails['min_salary'] as int? ?? 0;
    final maxSalary = jobVacancyDetails['max_salary'] as int? ?? 0;
    final requirements = jobVacancyDetails['requirements'] as List? ?? [];

    final applicationDate = createdAt > 0
        ? _formatDate(DateTime.fromMillisecondsSinceEpoch(createdAt * 1000))
        : 'Unknown date';

    final location = [
      candidateCity,
      candidateState,
      candidateCountry,
    ].where((s) => s.isNotEmpty).join(', ');

    final salaryRange = minSalary > 0 && maxSalary > 0
        ? '‚Çπ${_formatNumber(minSalary)} - ‚Çπ${_formatNumber(maxSalary)}'
        : 'Salary not specified';

    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => DraggableScrollableSheet(
        initialChildSize: 0.7,
        maxChildSize: 0.95,
        minChildSize: 0.5,
        builder: (context, scrollController) => Container(
          decoration: BoxDecoration(
            color: Theme.of(context).colorScheme.surface,
            borderRadius: const BorderRadius.vertical(top: Radius.circular(20)),
          ),
          child: Column(
            children: [
              // Handle bar
              Container(
                margin: const EdgeInsets.only(top: 8),
                width: 40,
                height: 4,
                decoration: BoxDecoration(
                  color: Theme.of(context).colorScheme.outline.withOpacity(0.3),
                  borderRadius: BorderRadius.circular(2),
                ),
              ),
              // Content
              Expanded(
                child: SingleChildScrollView(
                  controller: scrollController,
                  padding: const EdgeInsets.all(24),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      // Header
                      Row(
                        children: [
                          ClipRRect(
                            borderRadius: BorderRadius.circular(30),
                            child: candidateImage != null
                                ? Image.network(
                                    candidateImage,
                                    width: 60,
                                    height: 60,
                                    fit: BoxFit.cover,
                                    errorBuilder:
                                        (context, error, stackTrace) =>
                                            _buildDefaultAvatar(60),
                                  )
                                : _buildDefaultAvatar(60),
                          ),
                          const SizedBox(width: 16),
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  candidateName.isNotEmpty
                                      ? candidateName
                                      : 'Unknown Candidate',
                                  style: Theme.of(context)
                                      .textTheme
                                      .headlineSmall
                                      ?.copyWith(fontWeight: FontWeight.bold),
                                ),
                                if (location.isNotEmpty) ...[
                                  const SizedBox(height: 4),
                                  Row(
                                    children: [
                                      Icon(
                                        Icons.location_on,
                                        size: 16,
                                        color: Theme.of(
                                          context,
                                        ).colorScheme.primary,
                                      ),
                                      const SizedBox(width: 4),
                                      Flexible(
                                        child: Text(
                                          location,
                                          overflow: TextOverflow.ellipsis,
                                        ),
                                      ),
                                    ],
                                  ),
                                ],
                                const SizedBox(height: 4),
                                Text(
                                  'Applied on $applicationDate',
                                  style: Theme.of(context).textTheme.bodyMedium
                                      ?.copyWith(
                                        color: Theme.of(context)
                                            .colorScheme
                                            .onSurface
                                            .withOpacity(0.7),
                                      ),
                                ),
                              ],
                            ),
                          ),
                          _buildStatusChip(applicationStatus),
                        ],
                      ),

                      const SizedBox(height: 24),

                      // Job Information
                      _buildDetailSection('Job Information', [
                        _buildDetailRow('Position', jobTitle),
                        _buildDetailRow('Location', jobLocation),
                        _buildDetailRow('Type', _formatJobType(jobType)),
                        _buildDetailRow('Salary', salaryRange),
                      ]),

                      if (jobDescription.isNotEmpty) ...[
                        const SizedBox(height: 20),
                        _buildDetailSection('Job Description', [
                          Padding(
                            padding: const EdgeInsets.only(top: 8),
                            child: Text(
                              jobDescription,
                              style: Theme.of(context).textTheme.bodyMedium,
                            ),
                          ),
                        ]),
                      ],

                      if (requirements.isNotEmpty) ...[
                        const SizedBox(height: 20),
                        _buildDetailSection(
                          'Job Requirements',
                          requirements.map((req) {
                            final title =
                                req['requirement_title'] as String? ?? '';
                            final description =
                                req['requirement_description'] as String? ?? '';
                            return Padding(
                              padding: const EdgeInsets.only(bottom: 8),
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  if (title.isNotEmpty)
                                    Text(
                                      '‚Ä¢ $title',
                                      style: Theme.of(context)
                                          .textTheme
                                          .bodyMedium
                                          ?.copyWith(
                                            fontWeight: FontWeight.w600,
                                          ),
                                    ),
                                  if (description.isNotEmpty)
                                    Padding(
                                      padding: const EdgeInsets.only(
                                        left: 12,
                                        top: 2,
                                      ),
                                      child: Text(
                                        description,
                                        style: Theme.of(context)
                                            .textTheme
                                            .bodySmall
                                            ?.copyWith(
                                              color: Theme.of(context)
                                                  .colorScheme
                                                  .onSurface
                                                  .withOpacity(0.7),
                                            ),
                                      ),
                                    ),
                                ],
                              ),
                            );
                          }).toList(),
                        ),
                      ],

                      // Candidate Information
                      const SizedBox(height: 20),
                      _buildDetailSection('Candidate Information', [
                        if (experienceYears > 0)
                          _buildDetailRow(
                            'Experience',
                            '$experienceYears years',
                          ),
                        if (candidateBio.isNotEmpty &&
                            candidateBio != 'No bio available')
                          Padding(
                            padding: const EdgeInsets.only(top: 8),
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  'Bio',
                                  style: Theme.of(context).textTheme.bodyMedium
                                      ?.copyWith(fontWeight: FontWeight.w600),
                                ),
                                const SizedBox(height: 4),
                                Text(
                                  candidateBio,
                                  style: Theme.of(context).textTheme.bodyMedium,
                                ),
                              ],
                            ),
                          ),
                      ]),

                      // Skills
                      if (skills.isNotEmpty) ...[
                        const SizedBox(height: 20),
                        _buildDetailSection('Skills', [
                          Padding(
                            padding: const EdgeInsets.only(top: 8),
                            child: Wrap(
                              spacing: 8,
                              runSpacing: 8,
                              children: skills.map((skill) {
                                final skillName = skill is Map
                                    ? skill['skill_name'] ?? skill.toString()
                                    : skill.toString();
                                return Chip(
                                  label: Text(skillName),
                                  backgroundColor: Theme.of(
                                    context,
                                  ).colorScheme.primaryContainer,
                                );
                              }).toList(),
                            ),
                          ),
                        ]),
                      ],

                      const SizedBox(height: 40),

                      // Action buttons - Only Close button
                      SizedBox(
                        width: double.infinity,
                        child: ElevatedButton(
                          onPressed: () => Navigator.pop(context),
                          child: const Text('Close'),
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildDefaultAvatar(double size) {
    return Container(
      width: size,
      height: size,
      decoration: BoxDecoration(
        color: Theme.of(context).colorScheme.primaryContainer,
        borderRadius: BorderRadius.circular(size / 2),
      ),
      child: Icon(
        Icons.person,
        size: size * 0.6,
        color: Theme.of(context).colorScheme.onPrimaryContainer,
      ),
    );
  }

  void _showJobInviteDetails(Map<String, dynamic> invite) {
    final employeeDetails =
        invite['employee_details'] as Map<String, dynamic>? ?? {};
    final jobVacancyDetails =
        invite['job_vacancy_details'] as Map<String, dynamic>? ?? {};
    final businessDetails =
        invite['business_details'] as Map<String, dynamic>? ?? {};
    final isAccepted = invite['is_accepted'] as bool? ?? false;
    final isActive = invite['is_active'] as bool? ?? true;
    final createdAt = invite['created_at'] as int? ?? 0;

    // Format dates
    final inviteDate = createdAt > 0
        ? DateTime.fromMillisecondsSinceEpoch(createdAt * 1000)
        : DateTime.now();
    final formattedInviteDate = _formatDate(inviteDate);

    final lastDateToApply =
        jobVacancyDetails['last_date_to_apply'] as int? ?? 0;
    final formattedLastDate = lastDateToApply > 0
        ? _formatDate(
            DateTime.fromMillisecondsSinceEpoch(lastDateToApply * 1000),
          )
        : 'Not specified';

    // Format salary range
    final minSalary = jobVacancyDetails['min_salary'] as int? ?? 0;
    final maxSalary = jobVacancyDetails['max_salary'] as int? ?? 0;
    final salaryRange = minSalary > 0 && maxSalary > 0
        ? '‚Çπ${minSalary.toString().replaceAllMapped(RegExp(r'(\d{1,3})(?=(\d{3})+(?!\d))'), (Match m) => '${m[1]},')} - ‚Çπ${maxSalary.toString().replaceAllMapped(RegExp(r'(\d{1,3})(?=(\d{3})+(?!\d))'), (Match m) => '${m[1]},')}'
        : 'Salary not specified';

    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => DraggableScrollableSheet(
        initialChildSize: 0.7,
        maxChildSize: 0.9,
        minChildSize: 0.5,
        builder: (context, scrollController) => Container(
          decoration: BoxDecoration(
            color: Theme.of(context).colorScheme.surface,
            borderRadius: const BorderRadius.vertical(top: Radius.circular(20)),
          ),
          child: Column(
            children: [
              // Handle bar
              Container(
                margin: const EdgeInsets.symmetric(vertical: 12),
                width: 40,
                height: 4,
                decoration: BoxDecoration(
                  color: Theme.of(
                    context,
                  ).colorScheme.onSurface.withOpacity(0.3),
                  borderRadius: BorderRadius.circular(2),
                ),
              ),
              // Content
              Expanded(
                child: SingleChildScrollView(
                  controller: scrollController,
                  padding: const EdgeInsets.all(24),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      // Header
                      Row(
                        children: [
                          ClipRRect(
                            borderRadius: BorderRadius.circular(30),
                            child: Image.network(
                              employeeDetails['img_url'] ?? '',
                              width: 60,
                              height: 60,
                              fit: BoxFit.cover,
                              errorBuilder: (context, error, stackTrace) =>
                                  Container(
                                    width: 60,
                                    height: 60,
                                    color: Theme.of(
                                      context,
                                    ).colorScheme.primaryContainer,
                                    child: Icon(
                                      Icons.person,
                                      color: Theme.of(
                                        context,
                                      ).colorScheme.onPrimaryContainer,
                                      size: 30,
                                    ),
                                  ),
                            ),
                          ),
                          const SizedBox(width: 16),
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  '${employeeDetails['first_name'] ?? ''} ${employeeDetails['last_name'] ?? ''}'
                                      .trim(),
                                  style: Theme.of(context)
                                      .textTheme
                                      .headlineSmall
                                      ?.copyWith(fontWeight: FontWeight.bold),
                                ),
                                Text(
                                  '@${employeeDetails['username'] ?? 'username'}',
                                  style: Theme.of(context).textTheme.bodyMedium
                                      ?.copyWith(
                                        color: Theme.of(
                                          context,
                                        ).colorScheme.primary,
                                      ),
                                ),
                                Container(
                                  margin: const EdgeInsets.only(top: 8),
                                  padding: const EdgeInsets.symmetric(
                                    horizontal: 12,
                                    vertical: 4,
                                  ),
                                  decoration: BoxDecoration(
                                    color: !isActive
                                        ? Colors.grey
                                        : (isAccepted
                                              ? Colors.green
                                              : Colors.orange),
                                    borderRadius: BorderRadius.circular(16),
                                  ),
                                  child: Text(
                                    !isActive
                                        ? 'Withdrawn'
                                        : (isAccepted ? 'Accepted' : 'Pending'),
                                    style: const TextStyle(
                                      color: Colors.white,
                                      fontSize: 12,
                                      fontWeight: FontWeight.w500,
                                    ),
                                  ),
                                ),
                              ],
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 24),

                      // Job Details Section
                      _buildDetailSection('Job Details', [
                        _buildDetailRow(
                          'Position',
                          jobVacancyDetails['job_title'] ?? 'Not specified',
                        ),
                        _buildDetailRow(
                          'Description',
                          jobVacancyDetails['job_description'] ??
                              'No description provided',
                        ),
                        _buildDetailRow(
                          'Location',
                          jobVacancyDetails['job_location'] ?? 'Not specified',
                        ),
                        _buildDetailRow(
                          'Type',
                          _formatJobType(jobVacancyDetails['job_type'] ?? ''),
                        ),
                        _buildDetailRow('Salary Range', salaryRange),
                        _buildDetailRow(
                          'Last Date to Apply',
                          formattedLastDate,
                        ),
                      ]),

                      const SizedBox(height: 20),

                      // Invite Details Section
                      _buildDetailSection('Invite Information', [
                        _buildDetailRow('Invite Date', formattedInviteDate),
                        _buildDetailRow('Invite ID', invite['id'] ?? 'Unknown'),
                        _buildDetailRow(
                          'Status',
                          !isActive
                              ? 'Withdrawn by Business'
                              : (isAccepted
                                    ? 'Accepted by Employee'
                                    : 'Awaiting Response'),
                        ),
                      ]),

                      const SizedBox(height: 32),

                      // Action Buttons
                      Row(
                        children: [
                          Expanded(
                            child: OutlinedButton(
                              onPressed: () => Navigator.pop(context),
                              child: const Text('Close'),
                            ),
                          ),
                          if (isActive && !isAccepted) ...[
                            const SizedBox(width: 16),
                            Expanded(
                              child: ElevatedButton(
                                onPressed: () {
                                  Navigator.pop(context);
                                  _withdrawJobInvite(invite);
                                },
                                style: ElevatedButton.styleFrom(
                                  backgroundColor: Theme.of(
                                    context,
                                  ).colorScheme.error,
                                  foregroundColor: Theme.of(
                                    context,
                                  ).colorScheme.onError,
                                ),
                                child: const Text('Withdraw'),
                              ),
                            ),
                          ],
                        ],
                      ),
                    ],
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildDetailSection(String title, List<Widget> children) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          title,
          style: Theme.of(
            context,
          ).textTheme.titleLarge?.copyWith(fontWeight: FontWeight.bold),
        ),
        const SizedBox(height: 12),
        ...children,
      ],
    );
  }

  Widget _buildDetailRow(String label, String value) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 12),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          SizedBox(
            width: 120,
            child: Text(
              label,
              style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                fontWeight: FontWeight.w500,
                color: Theme.of(context).colorScheme.onSurface.withOpacity(0.7),
              ),
            ),
          ),
          Expanded(
            child: Text(value, style: Theme.of(context).textTheme.bodyMedium),
          ),
        ],
      ),
    );
  }

  void _withdrawJobInvite(Map<String, dynamic> invite) {
    final employeeName =
        '${invite['employee_details']?['first_name'] ?? ''} ${invite['employee_details']?['last_name'] ?? ''}'
            .trim();
    final jobTitle =
        invite['job_vacancy_details']?['job_title'] ?? 'this position';

    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Withdraw Job Invite'),
        content: Text(
          'Are you sure you want to withdraw the job invite for $employeeName to apply for $jobTitle?\n\nThis action cannot be undone.',
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('Cancel'),
          ),
          ElevatedButton(
            onPressed: () async {
              Navigator.pop(context); // Close dialog
              await _performWithdrawJobInvite(invite['id']);
            },
            style: ElevatedButton.styleFrom(
              backgroundColor: Theme.of(context).colorScheme.error,
              foregroundColor: Theme.of(context).colorScheme.onError,
            ),
            child: const Text('Withdraw'),
          ),
        ],
      ),
    );
  }

  Future<void> _performWithdrawJobInvite(String offeringId) async {
    try {
      // Show loading indicator
      showDialog(
        context: context,
        barrierDismissible: false,
        builder: (context) => AlertDialog(
          content: IntrinsicHeight(
            child: Row(
              mainAxisSize: MainAxisSize.min,
              children: [
                const CircularProgressIndicator(),
                const SizedBox(width: 16),
                Expanded(
                  child: Text(
                    'Withdrawing job invite...',
                    style: Theme.of(context).textTheme.bodyMedium,
                    overflow: TextOverflow.ellipsis,
                    maxLines: 2,
                  ),
                ),
              ],
            ),
          ),
        ),
      );

      final response = await ApiService.put(
        '/withdraw-my-jobofferings/',
        body: {'offering_id': offeringId},
        useBearerToken: true,
      );

      // Close loading dialog
      if (mounted) Navigator.pop(context);

      if (response['data'] != null && response['data']['status'] == 200) {
        // Show success message
        final message =
            response['data']['message'] ?? 'Job invite withdrawn successfully';
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Row(
                children: [
                  const Icon(Icons.check_circle, color: Colors.white, size: 16),
                  const SizedBox(width: 8),
                  Expanded(child: Text(message)),
                ],
              ),
              backgroundColor: Colors.green,
              duration: const Duration(seconds: 3),
              behavior: SnackBarBehavior.floating,
              margin: const EdgeInsets.all(16),
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(8),
              ),
            ),
          );
        }

        // Refresh the job invites list
        await _fetchBusinessJobInvites();
      } else {
        // Show error message from server
        final errorMessage =
            response['data']?['message'] ?? 'Failed to withdraw job invite';
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Row(
                children: [
                  const Icon(
                    Icons.error_outline,
                    color: Colors.white,
                    size: 16,
                  ),
                  const SizedBox(width: 8),
                  Expanded(child: Text(errorMessage)),
                ],
              ),
              backgroundColor: Theme.of(context).colorScheme.error,
              duration: const Duration(seconds: 4),
              behavior: SnackBarBehavior.floating,
              margin: const EdgeInsets.all(16),
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(8),
              ),
            ),
          );
        }
      }
    } catch (e) {
      // Close loading dialog if still open
      if (mounted) Navigator.pop(context);

      print('‚ùå Error withdrawing job invite: $e');
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Row(
              children: [
                const Icon(Icons.error_outline, color: Colors.white, size: 16),
                const SizedBox(width: 8),
                Expanded(
                  child: Text('Network error: Failed to withdraw job invite'),
                ),
              ],
            ),
            backgroundColor: Theme.of(context).colorScheme.error,
            duration: const Duration(seconds: 4),
            behavior: SnackBarBehavior.floating,
            margin: const EdgeInsets.all(16),
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(8),
            ),
          ),
        );
      }
    }
  }

  Widget _buildHireRequestCard(Map<String, dynamic> request) {
    final theme = Theme.of(context);
    return Container(
      margin: const EdgeInsets.only(bottom: 16),
      decoration: BoxDecoration(
        color: theme.colorScheme.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: theme.colorScheme.outline.withOpacity(0.2)),
        boxShadow: [
          BoxShadow(
            color: theme.colorScheme.shadow.withOpacity(0.1),
            blurRadius: 8,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: Padding(
        padding: const EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                ClipRRect(
                  borderRadius: BorderRadius.circular(25),
                  child: Image.network(
                    request['avatar'],
                    width: 50,
                    height: 50,
                    fit: BoxFit.cover,
                    errorBuilder: (context, error, stackTrace) => Container(
                      width: 50,
                      height: 50,
                      color: theme.colorScheme.primaryContainer,
                      child: Icon(
                        Icons.person,
                        color: theme.colorScheme.onPrimaryContainer,
                      ),
                    ),
                  ),
                ),
                const SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        request['candidateName'],
                        style: theme.textTheme.titleMedium?.copyWith(
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                      Text(
                        'Applied for ${request['position']}',
                        style: theme.textTheme.bodyMedium?.copyWith(
                          color: theme.colorScheme.primary,
                        ),
                      ),
                    ],
                  ),
                ),
                _buildStatusChip(request['status']),
              ],
            ),
            const SizedBox(height: 16),
            Wrap(
              spacing: 8,
              runSpacing: 4,
              children: [
                Row(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Icon(
                      Icons.work,
                      size: 16,
                      color: theme.colorScheme.primary,
                    ),
                    const SizedBox(width: 4),
                    Text(
                      '${request['experience']} experience',
                      style: theme.textTheme.bodySmall,
                    ),
                  ],
                ),
                Row(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Icon(
                      Icons.currency_rupee,
                      size: 16,
                      color: theme.colorScheme.primary,
                    ),
                    const SizedBox(width: 4),
                    Text(
                      request['expectedSalary'],
                      style: theme.textTheme.bodySmall,
                    ),
                  ],
                ),
              ],
            ),
            const SizedBox(height: 12),
            Wrap(
              spacing: 8,
              runSpacing: 4,
              children: (request['skills'] as List)
                  .map(
                    (skill) => Chip(
                      label: Text(skill, style: const TextStyle(fontSize: 12)),
                      backgroundColor: theme.colorScheme.primaryContainer,
                      visualDensity: VisualDensity.compact,
                    ),
                  )
                  .toList(),
            ),
            const SizedBox(height: 16),
            Row(
              children: [
                Expanded(
                  child: OutlinedButton(
                    onPressed: () {
                      // Reject request
                    },
                    child: const Text('Reject'),
                  ),
                ),
                const SizedBox(width: 12),
                Expanded(
                  child: ElevatedButton(
                    onPressed: () {
                      // Schedule interview
                    },
                    child: const Text('Interview'),
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildConnectionCard(Map<String, dynamic> connection) {
    final theme = Theme.of(context);
    final otherParty = connection['other_party'] as Map<String, dynamic>? ?? {};
    final connectionMessage = connection['connection_message'] as String? ?? '';
    final isAccepted = connection['is_accepted'] as bool? ?? false;
    final connectionType = connection['connection_type'] as String? ?? '';
    final timestamp = connection['timestamp'] as int? ?? 0;
    final connectionId = connection['id'] as String? ?? '';

    // Format timestamp to readable date
    final date = timestamp > 0
        ? DateTime.fromMillisecondsSinceEpoch(timestamp * 1000)
        : DateTime.now();
    final formattedDate = _formatDate(date);

    return Container(
      margin: const EdgeInsets.only(bottom: 16),
      decoration: BoxDecoration(
        color: theme.colorScheme.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: theme.colorScheme.outline.withOpacity(0.2)),
        boxShadow: [
          BoxShadow(
            color: theme.colorScheme.shadow.withOpacity(0.1),
            blurRadius: 8,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: Padding(
        padding: const EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                // Avatar placeholder (since API doesn't provide avatar URL)
                Container(
                  width: 50,
                  height: 50,
                  decoration: BoxDecoration(
                    color: theme.colorScheme.primaryContainer,
                    borderRadius: BorderRadius.circular(25),
                  ),
                  child: Icon(
                    Icons.person,
                    color: theme.colorScheme.onPrimaryContainer,
                    size: 24,
                  ),
                ),
                const SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        otherParty['name'] as String? ?? 'Unknown User',
                        style: theme.textTheme.titleMedium?.copyWith(
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                      Text(
                        '@${otherParty['username'] as String? ?? 'unknown'}',
                        style: theme.textTheme.bodyMedium?.copyWith(
                          color: theme.colorScheme.primary,
                        ),
                      ),
                      Text(
                        '${otherParty['type'] as String? ?? 'User'} ‚Ä¢ $connectionType',
                        style: theme.textTheme.bodySmall?.copyWith(
                          color: theme.colorScheme.onSurface.withOpacity(0.6),
                        ),
                      ),
                    ],
                  ),
                ),
                Column(
                  crossAxisAlignment: CrossAxisAlignment.end,
                  children: [
                    _buildConnectionStatusChip(isAccepted),
                    const SizedBox(height: 4),
                    Text(
                      formattedDate,
                      style: theme.textTheme.bodySmall?.copyWith(
                        color: theme.colorScheme.onSurface.withOpacity(0.6),
                      ),
                    ),
                  ],
                ),
              ],
            ),
            if (connectionMessage.isNotEmpty) ...[
              const SizedBox(height: 12),
              Container(
                padding: const EdgeInsets.all(12),
                decoration: BoxDecoration(
                  color: theme.colorScheme.surfaceVariant.withOpacity(0.3),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Text(
                  connectionMessage,
                  style: theme.textTheme.bodySmall?.copyWith(
                    fontStyle: FontStyle.italic,
                  ),
                ),
              ),
            ],

            // Accept/Reject toggle and Chat button
            if (connectionId.isNotEmpty) ...[
              const SizedBox(height: 16),
              if (isAccepted) ...[
                // Show Chat button when connection is accepted
                Row(
                  children: [
                    Expanded(
                      child: Container(
                        padding: const EdgeInsets.all(12),
                        decoration: BoxDecoration(
                          color: theme.colorScheme.surfaceVariant.withOpacity(
                            0.3,
                          ),
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: Row(
                          mainAxisAlignment: MainAxisAlignment.spaceBetween,
                          children: [
                            Expanded(
                              child: Text(
                                'Accept Connection',
                                style: theme.textTheme.bodyMedium?.copyWith(
                                  fontWeight: FontWeight.w500,
                                ),
                              ),
                            ),
                            Switch(
                              value: isAccepted,
                              onChanged: (value) {
                                _handleConnectionResponse(connectionId, value);
                              },
                              activeColor: Colors.green,
                              inactiveThumbColor: Colors.grey,
                              inactiveTrackColor: Colors.grey.withOpacity(0.3),
                            ),
                          ],
                        ),
                      ),
                    ),
                    const SizedBox(width: 12),
                    ElevatedButton(
                      onPressed: () => _openChatWithConnection(connection),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.blue,
                        foregroundColor: Colors.white,
                        padding: const EdgeInsets.symmetric(
                          horizontal: 16,
                          vertical: 12,
                        ),
                      ),
                      child: const Text('Chat'),
                    ),
                  ],
                ),
              ] else ...[
                // Show only toggle when connection is not accepted
                Container(
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: theme.colorScheme.surfaceVariant.withOpacity(0.3),
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      Expanded(
                        child: Text(
                          'Accept Connection',
                          style: theme.textTheme.bodyMedium?.copyWith(
                            fontWeight: FontWeight.w500,
                          ),
                        ),
                      ),
                      Switch(
                        value: isAccepted,
                        onChanged: (value) {
                          _handleConnectionResponse(connectionId, value);
                        },
                        activeColor: Colors.green,
                        inactiveThumbColor: Colors.grey,
                        inactiveTrackColor: Colors.grey.withOpacity(0.3),
                      ),
                    ],
                  ),
                ),
              ],
            ],
          ],
        ),
      ),
    );
  }

  /// Open chat with connection
  void _openChatWithConnection(Map<String, dynamic> connection) {
    final otherParty = connection['other_party'] as Map<String, dynamic>? ?? {};
    final connectionId = otherParty['id'];
    final connectionName = otherParty['name'] as String? ?? '';
    final connectionUsername = otherParty['username'] as String? ?? '';
    final contactImage = otherParty['img_url'] as String?;

    if (connectionId == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text(
            'Unable to start chat: Connection information not available',
          ),
          backgroundColor: Colors.red,
        ),
      );
      return;
    }

    // Get current professional ID as sender
    final professionalId = _professionalProfileData?['id'];
    if (professionalId == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text(
            'Unable to start chat: Professional information not available',
          ),
          backgroundColor: Colors.red,
        ),
      );
      return;
    }

    // Navigate to chat screen
    Navigator.pushNamed(
      context,
      '/chat',
      arguments: {
        'userId': connectionId,
        'senderId': professionalId,
        'receiverId': connectionId,
        'contactName': connectionName.isNotEmpty
            ? connectionName
            : (connectionUsername.isNotEmpty
                  ? '@$connectionUsername'
                  : 'Connection'),
        'contactImage': contactImage,
      },
    );
  }

  Widget _buildConnectionStatusChip(bool isAccepted) {
    final theme = Theme.of(context);
    final chipColor = isAccepted
        ? Colors.green.withOpacity(0.1)
        : Colors.orange.withOpacity(0.1);
    final textColor = isAccepted ? Colors.green[700]! : Colors.orange[700]!;
    final displayText = isAccepted ? 'Connected' : 'Pending';

    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
      decoration: BoxDecoration(
        color: chipColor,
        borderRadius: BorderRadius.circular(12),
      ),
      child: Text(
        displayText,
        style: TextStyle(
          color: textColor,
          fontWeight: FontWeight.w600,
          fontSize: 12,
        ),
      ),
    );
  }

  String _formatDate(DateTime date) {
    final now = DateTime.now();
    final difference = now.difference(date);

    if (difference.inDays > 7) {
      return '${date.day}/${date.month}/${date.year}';
    } else if (difference.inDays > 0) {
      return '${difference.inDays} day${difference.inDays > 1 ? 's' : ''} ago';
    } else if (difference.inHours > 0) {
      return '${difference.inHours} hour${difference.inHours > 1 ? 's' : ''} ago';
    } else if (difference.inMinutes > 0) {
      return '${difference.inMinutes} minute${difference.inMinutes > 1 ? 's' : ''} ago';
    } else {
      return 'Just now';
    }
  }

  Widget _buildStatusChip(String status) {
    Color chipColor;
    Color textColor;
    String displayText;

    switch (status.toLowerCase()) {
      case 'pending':
        chipColor = Colors.orange.withOpacity(0.1);
        textColor = Colors.orange[700]!;
        displayText = 'Pending';
        break;
      case 'interview':
      case 'reviewing':
        chipColor = Colors.blue.withOpacity(0.1);
        textColor = Colors.blue[700]!;
        displayText = status == 'interview' ? 'Interview' : 'Reviewing';
        break;
      case 'accepted':
        chipColor = Colors.green.withOpacity(0.1);
        textColor = Colors.green[700]!;
        displayText = 'Accepted';
        break;
      case 'rejected':
        chipColor = Colors.red.withOpacity(0.1);
        textColor = Colors.red[700]!;
        displayText = 'Rejected';
        break;
      case 'withdrawn':
        chipColor = Colors.grey.withOpacity(0.1);
        textColor = Colors.grey[700]!;
        displayText = 'Withdrawn';
        break;
      default:
        chipColor = Colors.grey.withOpacity(0.1);
        textColor = Colors.grey[700]!;
        displayText = status;
    }

    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
      decoration: BoxDecoration(
        color: chipColor,
        borderRadius: BorderRadius.circular(12),
      ),
      child: Text(
        displayText,
        style: TextStyle(
          color: textColor,
          fontWeight: FontWeight.w600,
          fontSize: 12,
        ),
      ),
    );
  }

  Widget _buildJobOfferingStatusChip(bool isAccepted) {
    final theme = Theme.of(context);
    final chipColor = isAccepted
        ? Colors.green.withOpacity(0.1)
        : Colors.orange.withOpacity(0.1);
    final textColor = isAccepted ? Colors.green[700]! : Colors.orange[700]!;
    final displayText = isAccepted ? 'Accepted' : 'Pending';

    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
      decoration: BoxDecoration(
        color: chipColor,
        borderRadius: BorderRadius.circular(12),
      ),
      child: Text(
        displayText,
        style: TextStyle(
          color: textColor,
          fontWeight: FontWeight.w600,
          fontSize: 12,
        ),
      ),
    );
  }

  String _formatJobType(String jobType) {
    switch (jobType.toLowerCase()) {
      case 'full_time':
        return 'Full-time';
      case 'part_time':
        return 'Part-time';
      case 'contract':
        return 'Contract';
      case 'freelance':
        return 'Freelance';
      case 'internship':
        return 'Internship';
      case 'temporary':
        return 'Temporary';
      default:
        return jobType.isNotEmpty ? jobType : 'Not specified';
    }
  }

  Widget _buildMediaGallerySection() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Padding(
          padding: const EdgeInsets.symmetric(horizontal: 16),
          child: Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text(
                'Media Gallery',
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                  color: Theme.of(context).colorScheme.onSurface,
                ),
              ),
              TextButton.icon(
                onPressed: _showAddMediaDialog,
                icon: const Icon(Icons.add_photo_alternate, size: 18),
                label: const Text('Add'),
                style: TextButton.styleFrom(
                  padding: const EdgeInsets.symmetric(horizontal: 12),
                  visualDensity: VisualDensity.compact,
                ),
              ),
            ],
          ),
        ),
        const SizedBox(height: 12),
        _isMediaLoading()
            ? const Center(
                child: Padding(
                  padding: EdgeInsets.all(16.0),
                  child: CircularProgressIndicator(),
                ),
              )
            : _getMediaError() != null
            ? Center(
                child: Padding(
                  padding: const EdgeInsets.all(16.0),
                  child: Column(
                    children: [
                      Icon(
                        Icons.error_outline,
                        color: Theme.of(context).colorScheme.error,
                      ),
                      const SizedBox(height: 8),
                      Text(
                        'Failed to load media',
                        style: TextStyle(
                          color: Theme.of(context).colorScheme.error,
                        ),
                      ),
                      TextButton(
                        onPressed: _refreshMedia,
                        child: const Text('Retry'),
                      ),
                    ],
                  ),
                ),
              )
            : _getMediaList().isEmpty
            ? Center(
                child: Padding(
                  padding: const EdgeInsets.all(16.0),
                  child: Column(
                    children: [
                      Icon(
                        Icons.photo_library_outlined,
                        size: 48,
                        color: Theme.of(
                          context,
                        ).colorScheme.onSurface.withOpacity(0.4),
                      ),
                      const SizedBox(height: 8),
                      Text(
                        'No media added yet',
                        style: TextStyle(
                          color: Theme.of(
                            context,
                          ).colorScheme.onSurface.withOpacity(0.6),
                        ),
                      ),
                      const SizedBox(height: 12),
                      ElevatedButton.icon(
                        onPressed: _showAddMediaDialog,
                        icon: const Icon(Icons.add_photo_alternate),
                        label: const Text('Add Media'),
                        style: ElevatedButton.styleFrom(
                          padding: const EdgeInsets.symmetric(
                            horizontal: 16,
                            vertical: 8,
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
              )
            : SizedBox(
                height: 120,
                child: ListView.builder(
                  padding: const EdgeInsets.symmetric(horizontal: 12),
                  scrollDirection: Axis.horizontal,
                  itemCount: _getMediaList().length,
                  itemBuilder: (context, index) {
                    final media = _getMediaList()[index];
                    return _buildMediaItem(media);
                  },
                ),
              ),
      ],
    );
  }

  Widget _buildMediaItem(Map<String, dynamic> media) {
    final mediaUrl = media['media_url'] as String?;
    final mediaType = media['media_type'] as String? ?? 'image';
    final mediaId = media['id'] as String?;
    final mediaDescription =
        media['media_description'] as String? ?? 'No description';

    return Container(
      width: 120,
      margin: const EdgeInsets.symmetric(horizontal: 4),
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(12),
        border: Border.all(
          color: Theme.of(context).colorScheme.outline.withOpacity(0.2),
        ),
      ),
      clipBehavior: Clip.antiAlias,
      child: Stack(
        fit: StackFit.expand,
        children: [
          // Media content
          if (mediaUrl != null)
            mediaType == 'video'
                ? Container(
                    color: Colors.black,
                    child: const Center(
                      child: Icon(
                        Icons.play_circle_outline,
                        color: Colors.white,
                        size: 40,
                      ),
                    ),
                  )
                : Image.network(
                    mediaUrl,
                    fit: BoxFit.cover,
                    errorBuilder: (context, error, stackTrace) => Container(
                      color: Theme.of(context).colorScheme.primaryContainer,
                      child: Icon(
                        Icons.broken_image,
                        color: Theme.of(context).colorScheme.onPrimaryContainer,
                      ),
                    ),
                    loadingBuilder: (context, child, loadingProgress) {
                      if (loadingProgress == null) return child;
                      return Center(
                        child: CircularProgressIndicator(
                          value: loadingProgress.expectedTotalBytes != null
                              ? loadingProgress.cumulativeBytesLoaded /
                                    loadingProgress.expectedTotalBytes!
                              : null,
                        ),
                      );
                    },
                  )
          else
            Container(
              color: Theme.of(context).colorScheme.primaryContainer,
              child: Icon(
                mediaType == 'video' ? Icons.videocam : Icons.image,
                color: Theme.of(context).colorScheme.onPrimaryContainer,
              ),
            ),

          // Media type indicator
          Positioned(
            top: 8,
            right: 8,
            child: Container(
              padding: const EdgeInsets.all(4),
              decoration: BoxDecoration(
                color: Colors.black.withOpacity(0.6),
                borderRadius: BorderRadius.circular(4),
              ),
              child: Icon(
                mediaType == 'video' ? Icons.videocam : Icons.image,
                color: Colors.white,
                size: 14,
              ),
            ),
          ),

          // Tap overlay
          Material(
            color: Colors.transparent,
            child: InkWell(
              onTap: () {
                // Show full view dialog with delete option
                _showMediaFullView(media);
              },
              splashColor: Theme.of(
                context,
              ).colorScheme.primary.withOpacity(0.3),
            ),
          ),
        ],
      ),
    );
  }

  void _showAddMediaDialog() {
    String selectedMediaType = 'image';
    File? selectedFile;
    final TextEditingController descriptionController = TextEditingController();
    final TextEditingController captionController = TextEditingController();
    bool isUploading = false;
    final theme = Theme.of(context);

    // Function to handle direct image selection from gallery
    Future<void> selectImage(StateSetter bottomSheetSetState) async {
      print('üöÄ === MEDIA IMAGE SELECTION STARTED ===');
      print('üì∏ Selecting image from gallery...');
      try {
        // Use ImagePickerUtils for simple image selection
        print(
          'üì∏ Calling ImagePickerUtils.showImageSourceBottomSheet for media...',
        );
        final File? imageFile =
            await ImagePickerUtils.showImageSourceBottomSheet(context);

        print(
          'üì∏ Media image picker result: ${imageFile != null ? "File selected" : "No file selected"}',
        );

        if (imageFile != null && mounted) {
          print('üì∏ File path: ${imageFile.path}');
          print('üì∏ File exists: ${await imageFile.exists()}');
          print('üì∏ File size: ${await imageFile.length()} bytes');

          // Update state in the bottom sheet
          bottomSheetSetState(() {
            selectedFile = imageFile;
            print('üì∏ State updated with selected file');
          });
        } else {
          print('üì∏ No media image selected or widget not mounted');
        }
      } catch (e, stackTrace) {
        print('‚ùå Error selecting image: $e');
        print('‚ùå Stack trace: $stackTrace');
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Error selecting image: $e'),
            backgroundColor: Colors.red,
          ),
        );
      }
      print('üèÅ === MEDIA IMAGE SELECTION COMPLETED ===');
    }

    // Function to handle upload
    Future<void> uploadMedia() async {
      print('üöÄ === MEDIA UPLOAD STARTED ===');
      print('üìã Selected file: ${selectedFile?.path}');
      print('üìã Media type: $selectedMediaType');
      print('üìã Description: ${descriptionController.text.trim()}');
      print('üìã Caption: ${captionController.text.trim()}');

      if (selectedFile == null) {
        print('‚ùå No file selected for upload');
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: const Text('Please select an image'),
            behavior: SnackBarBehavior.floating,
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(10),
            ),
            margin: const EdgeInsets.all(10),
          ),
        );
        return;
      }

      if (descriptionController.text.trim().isEmpty) {
        print('‚ùå No description provided for upload');
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: const Text('Please enter a description'),
            behavior: SnackBarBehavior.floating,
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(10),
            ),
            margin: const EdgeInsets.all(10),
          ),
        );
        return;
      }

      setState(() {
        isUploading = true;
      });
      print('üì§ Starting media upload process...');

      try {
        print('üöÄ Calling _uploadMedia function...');
        final result = await _uploadMedia(
          file: selectedFile!,
          mediaType: selectedMediaType,
          description: descriptionController.text.trim(),
          caption: captionController.text.trim(),
        );

        setState(() {
          isUploading = false;
        });

        Navigator.pop(context); // Close bottom sheet

        if (result) {
          // Refresh media list
          _refreshMedia();

          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Row(
                children: [
                  const Icon(Icons.check_circle, color: Colors.white),
                  const SizedBox(width: 10),
                  const Text('Image uploaded successfully'),
                ],
              ),
              backgroundColor: Colors.green,
              behavior: SnackBarBehavior.floating,
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(10),
              ),
              margin: const EdgeInsets.all(10),
            ),
          );
        }
      } catch (e) {
        setState(() {
          isUploading = false;
        });

        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Row(
              children: [
                const Icon(Icons.error, color: Colors.white),
                const SizedBox(width: 10),
                Expanded(child: Text('Error uploading image: $e')),
              ],
            ),
            backgroundColor: Colors.red,
            behavior: SnackBarBehavior.floating,
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(10),
            ),
            margin: const EdgeInsets.all(10),
          ),
        );
      }
    }

    // Show the bottom sheet
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (BuildContext context) {
        return StatefulBuilder(
          builder: (context, bottomSheetSetState) {
            return Container(
              height: MediaQuery.of(context).size.height * 0.85,
              decoration: BoxDecoration(
                color: theme.colorScheme.surface,
                borderRadius: const BorderRadius.only(
                  topLeft: Radius.circular(25),
                  topRight: Radius.circular(25),
                ),
                boxShadow: [
                  BoxShadow(
                    color: Colors.black.withOpacity(0.1),
                    blurRadius: 10,
                    offset: const Offset(0, -5),
                  ),
                ],
              ),
              child: Column(
                children: [
                  // Handle bar at top
                  Container(
                    width: 40,
                    height: 4,
                    margin: const EdgeInsets.only(top: 12, bottom: 8),
                    decoration: BoxDecoration(
                      color: theme.colorScheme.onSurface.withOpacity(0.2),
                      borderRadius: BorderRadius.circular(2),
                    ),
                  ),

                  // Header
                  Padding(
                    padding: const EdgeInsets.symmetric(horizontal: 20),
                    child: Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        Text(
                          'Upload Image',
                          style: theme.textTheme.titleLarge?.copyWith(
                            fontWeight: FontWeight.bold,
                            color: theme.colorScheme.onSurface,
                          ),
                        ),
                        IconButton(
                          icon: Icon(
                            Icons.close,
                            color: theme.colorScheme.onSurface,
                          ),
                          onPressed: () => Navigator.pop(context),
                        ),
                      ],
                    ),
                  ),

                  // Content
                  Expanded(
                    child: SingleChildScrollView(
                      padding: const EdgeInsets.all(20),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          // Image selection area
                          GestureDetector(
                            onTap: () => selectImage(bottomSheetSetState),
                            child: Container(
                              height: 200,
                              width: double.infinity,
                              decoration: BoxDecoration(
                                color: theme.colorScheme.surfaceVariant
                                    .withOpacity(0.3),
                                borderRadius: BorderRadius.circular(15),
                                border: Border.all(
                                  color: selectedFile != null
                                      ? theme.colorScheme.primary
                                      : theme.colorScheme.outline.withOpacity(
                                          0.3,
                                        ),
                                  width: selectedFile != null ? 2 : 1,
                                ),
                              ),
                              child: selectedFile != null
                                  ? ClipRRect(
                                      borderRadius: BorderRadius.circular(14),
                                      child: Stack(
                                        fit: StackFit.expand,
                                        children: [
                                          Image.file(
                                            selectedFile!,
                                            fit: BoxFit.cover,
                                            errorBuilder:
                                                (context, error, stackTrace) =>
                                                    Center(
                                                      child: Icon(
                                                        Icons.broken_image,
                                                        size: 64,
                                                        color: theme
                                                            .colorScheme
                                                            .error,
                                                      ),
                                                    ),
                                          ),
                                          Positioned(
                                            right: 10,
                                            top: 10,
                                            child: GestureDetector(
                                              onTap: () => selectImage(
                                                bottomSheetSetState,
                                              ),
                                              child: Container(
                                                padding: const EdgeInsets.all(
                                                  8,
                                                ),
                                                decoration: BoxDecoration(
                                                  color:
                                                      theme.colorScheme.primary,
                                                  shape: BoxShape.circle,
                                                ),
                                                child: Icon(
                                                  Icons.edit,
                                                  color: theme
                                                      .colorScheme
                                                      .onPrimary,
                                                  size: 16,
                                                ),
                                              ),
                                            ),
                                          ),
                                        ],
                                      ),
                                    )
                                  : Column(
                                      mainAxisAlignment:
                                          MainAxisAlignment.center,
                                      children: [
                                        Container(
                                          padding: const EdgeInsets.all(16),
                                          decoration: BoxDecoration(
                                            color: theme.colorScheme.primary
                                                .withOpacity(0.1),
                                            shape: BoxShape.circle,
                                          ),
                                          child: Icon(
                                            Icons.photo_library_rounded,
                                            size: 40,
                                            color: theme.colorScheme.primary,
                                          ),
                                        ),
                                        const SizedBox(height: 12),
                                        Text(
                                          'Tap to select from Gallery',
                                          style: theme.textTheme.bodyMedium
                                              ?.copyWith(
                                                fontWeight: FontWeight.w500,
                                                color:
                                                    theme.colorScheme.primary,
                                              ),
                                        ),
                                        const SizedBox(height: 4),
                                        Text(
                                          'Choose a photo from your device',
                                          style: theme.textTheme.bodySmall
                                              ?.copyWith(
                                                color: theme
                                                    .colorScheme
                                                    .onSurface
                                                    .withOpacity(0.7),
                                              ),
                                        ),
                                        const SizedBox(height: 12),
                                        // Debug button for alternative selection
                                        ElevatedButton.icon(
                                          onPressed: () =>
                                              selectImage(bottomSheetSetState),
                                          icon: const Icon(Icons.photo_library),
                                          label: const Text('Open Gallery'),
                                          style: ElevatedButton.styleFrom(
                                            backgroundColor: theme
                                                .colorScheme
                                                .primaryContainer,
                                            foregroundColor: theme
                                                .colorScheme
                                                .onPrimaryContainer,
                                          ),
                                        ),
                                      ],
                                    ),
                            ),
                          ),
                          if (selectedFile != null)
                            Padding(
                              padding: const EdgeInsets.only(top: 8),
                              child: Row(
                                children: [
                                  Icon(
                                    Icons.check_circle,
                                    color: Colors.green,
                                    size: 16,
                                  ),
                                  const SizedBox(width: 6),
                                  Expanded(
                                    child: Text(
                                      path.basename(selectedFile!.path),
                                      style: theme.textTheme.bodySmall
                                          ?.copyWith(
                                            color: theme.colorScheme.onSurface
                                                .withOpacity(0.7),
                                          ),
                                      maxLines: 1,
                                      overflow: TextOverflow.ellipsis,
                                    ),
                                  ),
                                ],
                              ),
                            ),
                          const SizedBox(height: 20),

                          // Description field
                          Text(
                            'Description',
                            style: theme.textTheme.titleMedium?.copyWith(
                              fontWeight: FontWeight.w600,
                            ),
                          ),
                          const SizedBox(height: 8),
                          TextField(
                            controller: descriptionController,
                            decoration: InputDecoration(
                              hintText: 'Enter a description for your image',
                              border: OutlineInputBorder(
                                borderRadius: BorderRadius.circular(12),
                                borderSide: BorderSide(
                                  color: theme.colorScheme.outline.withOpacity(
                                    0.3,
                                  ),
                                ),
                              ),
                              enabledBorder: OutlineInputBorder(
                                borderRadius: BorderRadius.circular(12),
                                borderSide: BorderSide(
                                  color: theme.colorScheme.outline.withOpacity(
                                    0.3,
                                  ),
                                ),
                              ),
                              focusedBorder: OutlineInputBorder(
                                borderRadius: BorderRadius.circular(12),
                                borderSide: BorderSide(
                                  color: theme.colorScheme.primary,
                                ),
                              ),
                              contentPadding: const EdgeInsets.symmetric(
                                horizontal: 16,
                                vertical: 12,
                              ),
                            ),
                            maxLines: 2,
                          ),
                          const SizedBox(height: 16),

                          // Caption field
                          Text(
                            'Caption (Optional)',
                            style: theme.textTheme.titleMedium?.copyWith(
                              fontWeight: FontWeight.w600,
                            ),
                          ),
                          const SizedBox(height: 8),
                          TextField(
                            controller: captionController,
                            decoration: InputDecoration(
                              hintText: 'Add a caption',
                              border: OutlineInputBorder(
                                borderRadius: BorderRadius.circular(12),
                                borderSide: BorderSide(
                                  color: theme.colorScheme.outline.withOpacity(
                                    0.3,
                                  ),
                                ),
                              ),
                              enabledBorder: OutlineInputBorder(
                                borderRadius: BorderRadius.circular(12),
                                borderSide: BorderSide(
                                  color: theme.colorScheme.outline.withOpacity(
                                    0.3,
                                  ),
                                ),
                              ),
                              focusedBorder: OutlineInputBorder(
                                borderRadius: BorderRadius.circular(12),
                                borderSide: BorderSide(
                                  color: theme.colorScheme.primary,
                                ),
                              ),
                              contentPadding: const EdgeInsets.symmetric(
                                horizontal: 16,
                                vertical: 12,
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),

                  // Bottom buttons
                  Container(
                    padding: EdgeInsets.only(
                      left: 20,
                      right: 20,
                      bottom: 20 + MediaQuery.of(context).padding.bottom,
                      top: 12,
                    ),
                    decoration: BoxDecoration(
                      color: theme.colorScheme.surface,
                      boxShadow: [
                        BoxShadow(
                          color: Colors.black.withOpacity(0.05),
                          blurRadius: 5,
                          offset: const Offset(0, -3),
                        ),
                      ],
                    ),
                    child: Row(
                      children: [
                        Expanded(
                          child: TextButton(
                            onPressed: isUploading
                                ? null
                                : () => Navigator.pop(context),
                            style: TextButton.styleFrom(
                              padding: const EdgeInsets.symmetric(vertical: 12),
                              shape: RoundedRectangleBorder(
                                borderRadius: BorderRadius.circular(12),
                              ),
                            ),
                            child: Text(
                              'Cancel',
                              style: TextStyle(
                                color: theme.colorScheme.onSurface,
                              ),
                            ),
                          ),
                        ),
                        const SizedBox(width: 16),
                        Expanded(
                          child: ElevatedButton(
                            onPressed: isUploading
                                ? null
                                : () async {
                                    if (selectedFile == null) {
                                      ScaffoldMessenger.of(
                                        context,
                                      ).showSnackBar(
                                        SnackBar(
                                          content: const Text(
                                            'Please select an image',
                                          ),
                                          behavior: SnackBarBehavior.floating,
                                          shape: RoundedRectangleBorder(
                                            borderRadius: BorderRadius.circular(
                                              10,
                                            ),
                                          ),
                                          margin: const EdgeInsets.all(10),
                                        ),
                                      );
                                      return;
                                    }

                                    if (descriptionController.text
                                        .trim()
                                        .isEmpty) {
                                      ScaffoldMessenger.of(
                                        context,
                                      ).showSnackBar(
                                        SnackBar(
                                          content: const Text(
                                            'Please enter a description',
                                          ),
                                          behavior: SnackBarBehavior.floating,
                                          shape: RoundedRectangleBorder(
                                            borderRadius: BorderRadius.circular(
                                              10,
                                            ),
                                          ),
                                          margin: const EdgeInsets.all(10),
                                        ),
                                      );
                                      return;
                                    }

                                    bottomSheetSetState(() {
                                      isUploading = true;
                                    });

                                    try {
                                      final result = await _uploadMedia(
                                        file: selectedFile!,
                                        mediaType: selectedMediaType,
                                        description: descriptionController.text
                                            .trim(),
                                        caption: captionController.text.trim(),
                                      );

                                      if (!mounted) return;

                                      Navigator.pop(
                                        context,
                                      ); // Close bottom sheet

                                      if (result) {
                                        // Refresh media list
                                        _refreshMedia();

                                        ScaffoldMessenger.of(
                                          context,
                                        ).showSnackBar(
                                          SnackBar(
                                            content: Row(
                                              children: [
                                                const Icon(
                                                  Icons.check_circle,
                                                  color: Colors.white,
                                                ),
                                                const SizedBox(width: 10),
                                                const Text(
                                                  'Image uploaded successfully',
                                                ),
                                              ],
                                            ),
                                            backgroundColor: Colors.green,
                                            behavior: SnackBarBehavior.floating,
                                            shape: RoundedRectangleBorder(
                                              borderRadius:
                                                  BorderRadius.circular(10),
                                            ),
                                            margin: const EdgeInsets.all(10),
                                          ),
                                        );
                                      }
                                    } catch (e) {
                                      if (!mounted) return;

                                      bottomSheetSetState(() {
                                        isUploading = false;
                                      });

                                      ScaffoldMessenger.of(
                                        context,
                                      ).showSnackBar(
                                        SnackBar(
                                          content: Row(
                                            children: [
                                              const Icon(
                                                Icons.error,
                                                color: Colors.white,
                                              ),
                                              const SizedBox(width: 10),
                                              Expanded(
                                                child: Text(
                                                  'Error uploading image: $e',
                                                ),
                                              ),
                                            ],
                                          ),
                                          backgroundColor: Colors.red,
                                          behavior: SnackBarBehavior.floating,
                                          shape: RoundedRectangleBorder(
                                            borderRadius: BorderRadius.circular(
                                              10,
                                            ),
                                          ),
                                          margin: const EdgeInsets.all(10),
                                        ),
                                      );
                                    }
                                  },
                            style: ElevatedButton.styleFrom(
                              backgroundColor: theme.colorScheme.primary,
                              foregroundColor: theme.colorScheme.onPrimary,
                              padding: const EdgeInsets.symmetric(vertical: 12),
                              elevation: 0,
                              shape: RoundedRectangleBorder(
                                borderRadius: BorderRadius.circular(12),
                              ),
                            ),
                            child: isUploading
                                ? SizedBox(
                                    width: 20,
                                    height: 20,
                                    child: CircularProgressIndicator(
                                      strokeWidth: 2,
                                      color: theme.colorScheme.onPrimary,
                                    ),
                                  )
                                : const Text('Upload'),
                          ),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            );
          },
        );
      },
    );
  }

  Widget _buildFilePreview(File file, String mediaType) {
    return ClipRRect(
      borderRadius: BorderRadius.circular(8),
      child: Image.file(
        file,
        fit: BoxFit.cover,
        errorBuilder: (context, error, stackTrace) =>
            const Icon(Icons.broken_image),
      ),
    );
  }

  Future<bool> _uploadMedia({
    required File file,
    required String mediaType,
    required String description,
    String? caption,
  }) async {
    print('üöÄ === _uploadMedia FUNCTION STARTED ===');
    print('üì§ UserProfileEditableScreen: Uploading ${widget.profile} media...');
    print('üìÑ File: ${file.path}');
    print('üìÑ File exists: ${await file.exists()}');
    print('üìÑ File size: ${await file.length()} bytes');
    print('üìù Media Type: $mediaType');
    print('üìù Description: $description');
    print('üìù Caption: $caption');

    try {
      if (widget.profile == 'employee') {
        print('üîÑ Routing to employee media upload...');
        final result = await _uploadEmployeeMedia(
          file: file,
          mediaType: mediaType,
          description: description,
          caption: caption,
        );
        print('üì• Employee media upload result: $result');
        return result;
      } else if (widget.profile == 'professional') {
        print('üîÑ Routing to professional media upload...');
        final result = await _uploadProfessionalMedia(
          file: file,
          mediaType: mediaType,
          description: description,
          caption: caption,
        );
        print('üì• Professional media upload result: $result');
        return result;
      } else if (widget.profile == 'business') {
        print('üîÑ Routing to business media upload...');
        final result = await _uploadBusinessMedia(
          file: file,
          mediaType: mediaType,
          description: description,
          caption: caption,
        );
        print('üì• Business media upload result: $result');
        return result;
      } else {
        print('‚ùå Unknown profile type: ${widget.profile}');
        throw Exception('Unknown profile type: ${widget.profile}');
      }
    } catch (e, stackTrace) {
      print('‚ùå Exception during media upload: $e');
      print('‚ùå Stack trace: $stackTrace');
      rethrow;
    } finally {
      print('üèÅ === _uploadMedia FUNCTION COMPLETED ===');
    }
  }

  Future<bool> _uploadEmployeeMedia({
    required File file,
    required String mediaType,
    required String description,
    String? caption,
  }) async {
    try {
      // Create additional fields map
      final Map<String, String> additionalFields = {
        'media_type': mediaType,
        'media_description': description,
      };

      if (caption != null && caption.isNotEmpty) {
        additionalFields['caption'] = caption;
      }

      // Use the ApiService to upload the image
      final response = await ApiService.uploadImage(
        '/create-employee-media/',
        imageFile: file,
        fieldName: 'file',
        additionalFields: additionalFields,
        useBearerToken: true,
      );

      print('üì• Employee media upload response: ${response['statusCode']}');

      if (response['statusCode'] == 200 || response['statusCode'] == 201) {
        print('‚úÖ Employee media uploaded successfully');
        return true;
      } else {
        print('‚ùå Employee media upload failed: ${response['statusCode']}');
        throw Exception('Failed to upload employee media: ${response['data']}');
      }
    } catch (e) {
      print('‚ùå Exception during employee media upload: $e');
      rethrow;
    }
  }

  Future<bool> _uploadProfessionalMedia({
    required File file,
    required String mediaType,
    required String description,
    String? caption,
  }) async {
    try {
      // Create additional fields map - same format as employee
      final Map<String, String> additionalFields = {
        'media_type': mediaType,
        'media_description': description,
      };

      if (caption != null && caption.isNotEmpty) {
        additionalFields['caption'] = caption;
      }

      // Use the ApiService to upload the image - same as employee
      final response = await ApiService.uploadImage(
        '/create-professional-media/',
        imageFile: file,
        fieldName: 'file',
        additionalFields: additionalFields,
        useBearerToken: true,
      );

      print('üì• Professional media upload response: ${response['statusCode']}');

      if (response['statusCode'] == 200 || response['statusCode'] == 201) {
        print('‚úÖ Professional media uploaded successfully');
        return true;
      } else {
        print('‚ùå Professional media upload failed: ${response['statusCode']}');
        throw Exception(
          'Failed to upload professional media: ${response['data']}',
        );
      }
    } catch (e) {
      print('‚ùå Exception during professional media upload: $e');
      rethrow;
    }
  }

  Future<bool> _uploadBusinessMedia({
    required File file,
    required String mediaType,
    required String description,
    String? caption,
  }) async {
    if (widget.userData == null || widget.userData!['id'] == null) {
      throw Exception('Business ID not available');
    }

    final businessId = widget.userData!['id'];

    try {
      await BusinessService.createBusinessMedia(
        businessId: businessId,
        imageFile: file,
        mediaType: mediaType,
        description: description,
        caption: caption,
      );

      print('‚úÖ Business media uploaded successfully');
      return true;
    } catch (e) {
      print('‚ùå Exception during business media upload: $e');
      rethrow;
    }
  }

  /// Update profile image for employee, professional, and business profiles
  Future<bool> _updateProfileImage(File imageFile) async {
    print('üöÄ === _updateProfileImage FUNCTION STARTED ===');
    print('üì§ UserProfileEditableScreen: Updating profile image...');
    print('üìã Current profile: ${widget.profile}');
    print('üìÑ File: ${imageFile.path}');
    print('üìÑ File exists: ${await imageFile.exists()}');
    print('üìÑ File size: ${await imageFile.length()} bytes');

    try {
      if (widget.profile == 'employee') {
        print('üîÑ Processing employee profile image upload...');
        // Use the ApiService to upload the employee profile image
        final response = await ApiService.uploadImage(
          '/update-employee-img/',
          imageFile: imageFile,
          fieldName: 'file',
          useBearerToken: true,
        );

        print(
          'üì• Employee profile image update response: ${response['statusCode']}',
        );
        print('üì• Response data: ${response['data']}');

        if (response['statusCode'] == 200 || response['statusCode'] == 201) {
          print('‚úÖ Employee profile image updated successfully');
          // Refresh employee profile data to get the updated image URL
          print('üîÑ Refreshing employee profile data...');
          await _fetchEmployeeProfile();
          return true;
        } else {
          print(
            '‚ùå Employee profile image update failed: ${response['statusCode']}',
          );
          throw Exception(
            'Failed to update employee profile image: ${response['data']}',
          );
        }
      } else if (widget.profile == 'professional') {
        print('üîÑ Processing professional profile image upload...');
        // Use the ProfessionalService to upload the professional profile image
// REMOVED:         final success =
// REMOVED:             await ProfessionalService.uploadProfessionalProfileImage(
// REMOVED:               imageFile: imageFile,
            );

        print('üì• Professional profile image upload result: $success');

        if (success) {
          print('‚úÖ Professional profile image updated successfully');
          // Refresh professional profile data to get the updated image URL
          print('üîÑ Refreshing professional profile data...');
          await _fetchProfessionalProfile();
          return true;
        } else {
          print('‚ùå Professional profile image update failed');
          throw Exception('Failed to update professional profile image');
        }
      } else if (widget.profile == 'business' && widget.userData != null) {
        print('üîÑ Processing business profile image upload...');
        // Use the BusinessService to upload the business profile image
        final businessId = widget.userData!['id'];
        print('üìã Business ID: $businessId');
        final success = await BusinessService.uploadBusinessProfileImage(
          businessId: businessId,
          imageFile: imageFile,
        );

        print('üì• Business profile image upload result: $success');

        if (success) {
          print('‚úÖ Business profile image updated successfully');
          // Refresh business profile data to get the updated image URL
          print('üîÑ Refreshing business profile data...');
          await _refreshBusinessProfile();
          return true;
        } else {
          print('‚ùå Business profile image update failed');
          throw Exception('Failed to update business profile image');
        }
      } else {
        print('‚ùå Invalid profile type or missing business data');
        print('üìã Profile: ${widget.profile}');
        print('üìã UserData: ${widget.userData}');
        throw Exception('Invalid profile type or missing business data');
      }
    } catch (e, stackTrace) {
      print('‚ùå Exception during profile image update: $e');
      print('‚ùå Stack trace: $stackTrace');
      rethrow;
    } finally {
      print('üèÅ === _updateProfileImage FUNCTION COMPLETED ===');
    }
  }

  Future<void> _showProfileImagePicker() async {
    debugPrint('üéØüéØüéØ FUNCTION CALLED! _showProfileImagePicker started');
    debugPrint('üöÄüöÄüöÄ === PROFILE IMAGE PICKER STARTED ===');
    debugPrint('üì∏üì∏üì∏ Opening profile image picker...');
    debugPrint('üìãüìãüìã Current profile: ${widget.profile}');

    // Show a simple snackbar to confirm the function is called
    if (mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Profile image picker called!'),
          duration: Duration(seconds: 1),
        ),
      );
    }

    try {
      // Use ImagePickerUtils for simple image selection
      print('üì∏ Calling ImagePickerUtils.showImageSourceBottomSheet...');
      final File? imageFile = await ImagePickerUtils.showImageSourceBottomSheet(
        context,
      );

      print(
        'üì∏ Image picker result: ${imageFile != null ? "File selected" : "No file selected"}',
      );

      if (imageFile != null && mounted) {
        print('üì∏ Profile image file path: ${imageFile.path}');
        print('üì∏ Profile image file exists: ${await imageFile.exists()}');
        print('üì∏ Profile image file size: ${await imageFile.length()} bytes');

        // Show loading dialog
        if (mounted) {
          print('üì∏ Showing loading dialog...');
          showDialog(
            context: context,
            barrierDismissible: false,
            builder: (context) => const AlertDialog(
              content: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  CircularProgressIndicator(),
                  SizedBox(height: 16),
                  Text('Uploading profile image...'),
                ],
              ),
            ),
          );
        }

        try {
          print('üöÄ Starting profile image upload...');
          // Upload the profile image
          final result = await _updateProfileImage(imageFile);
          print('üì• Profile image upload result: $result');

          // Close loading dialog
          if (mounted) {
            print('üì∏ Closing loading dialog...');
            Navigator.pop(context);
          }

          if (result && mounted) {
            print(
              '‚úÖ Profile image updated successfully - showing success message',
            );
            ScaffoldMessenger.of(context).showSnackBar(
              const SnackBar(
                content: Text('Profile image updated successfully'),
                backgroundColor: Colors.green,
              ),
            );
          } else {
            print('‚ùå Profile image update returned false');
            if (mounted) {
              ScaffoldMessenger.of(context).showSnackBar(
                const SnackBar(
                  content: Text('Failed to update profile image'),
                  backgroundColor: Colors.red,
                ),
              );
            }
          }
        } catch (e, stackTrace) {
          // Close loading dialog
          if (mounted) {
            Navigator.pop(context);
          }

          print('‚ùå Error updating profile image: $e');
          print('‚ùå Stack trace: $stackTrace');
          if (mounted) {
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(
                content: Text('Error updating profile image: $e'),
                backgroundColor: Colors.red,
                duration: const Duration(seconds: 5),
              ),
            );
          }
        }
      } else {
        print('üì∏ No image selected or widget not mounted');
      }
    } catch (e, stackTrace) {
      print('‚ùå Error in profile image picker: $e');
      print('‚ùå Stack trace: $stackTrace');
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Error selecting profile image: $e'),
            backgroundColor: Colors.red,
          ),
        );
      }
    }
    print('üèÅ === PROFILE IMAGE PICKER COMPLETED ===');
  }

  Future<void> _deleteMedia(String mediaId) async {
    // Show confirmation dialog
    final confirmed = await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Delete Media'),
        content: const Text(
          'Are you sure you want to delete this media? This action cannot be undone.',
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(context).pop(false),
            child: const Text('Cancel'),
          ),
          TextButton(
            onPressed: () => Navigator.of(context).pop(true),
            child: Text(
              'Delete',
              style: TextStyle(color: Theme.of(context).colorScheme.error),
            ),
          ),
        ],
      ),
    );

    if (confirmed != true) return;

    // Show loading indicator
    if (mounted) {
      ScaffoldMessenger.of(
        context,
      ).showSnackBar(const SnackBar(content: Text('Deleting media...')));
    }

    try {
      bool success = false;

      // Delete the media based on profile type
      if (widget.profile == 'employee') {
// REMOVED:         success = await EmployeeService.deleteMedia(mediaId);
      } else if (widget.profile == 'professional') {
// REMOVED:         success = await ProfessionalService.deleteMedia(mediaId);
      } else if (widget.profile == 'business') {
// REMOVED:         success = await BusinessService.deleteBusinessMedia(mediaId);
      }

      if (success && mounted) {
        // Remove the media from the appropriate list
        setState(() {
          if (widget.profile == 'employee') {
            _employeeMedia.removeWhere((m) => m['id'] == mediaId);
          } else if (widget.profile == 'professional') {
            _professionalMedia.removeWhere((m) => m['id'] == mediaId);
          } else if (widget.profile == 'business') {
            _businessMedia.removeWhere((m) => m['id'] == mediaId);
          }
        });

        // Show success message
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text('Media deleted successfully'),
              backgroundColor: Colors.green,
            ),
          );
        }
      }
    } catch (e) {
      // Show error message
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Error deleting media: $e'),
            backgroundColor: Colors.red,
          ),
        );
      }
    }
  }

  void _showMediaFullView(Map<String, dynamic> media) {
    final mediaUrl = media['media_url'] as String?;
    final mediaType = media['media_type'] as String? ?? 'image';
    final mediaId = media['id'] as String?;
    final mediaDescription =
        media['media_description'] as String? ?? 'No description';
    final mediaCaption = media['caption'] as String?;
    final theme = Theme.of(context);

    showDialog(
      context: context,
      builder: (context) => Dialog(
        backgroundColor: Colors.transparent,
        insetPadding: const EdgeInsets.all(16),
        child: Container(
          width: double.infinity,
          constraints: BoxConstraints(
            maxHeight: MediaQuery.of(context).size.height * 0.8,
            maxWidth: MediaQuery.of(context).size.width * 0.9,
          ),
          decoration: BoxDecoration(
            color: theme.colorScheme.surface,
            borderRadius: BorderRadius.circular(16),
          ),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.stretch,
            children: [
              // Media content
              Flexible(
                child: ClipRRect(
                  borderRadius: const BorderRadius.vertical(
                    top: Radius.circular(16),
                  ),
                  child: mediaUrl != null
                      ? mediaType == 'video'
                            ? Container(
                                color: Colors.black,
                                child: const Center(
                                  child: Icon(
                                    Icons.play_circle_outline,
                                    color: Colors.white,
                                    size: 80,
                                  ),
                                ),
                              )
                            : Image.network(
                                mediaUrl,
                                fit: BoxFit.contain,
                                errorBuilder: (context, error, stackTrace) =>
                                    Container(
                                      color: theme.colorScheme.primaryContainer,
                                      child: Icon(
                                        Icons.broken_image,
                                        color: theme
                                            .colorScheme
                                            .onPrimaryContainer,
                                        size: 80,
                                      ),
                                    ),
                              )
                      : Container(
                          color: theme.colorScheme.primaryContainer,
                          child: Icon(
                            mediaType == 'video' ? Icons.videocam : Icons.image,
                            color: theme.colorScheme.onPrimaryContainer,
                            size: 80,
                          ),
                        ),
                ),
              ),

              // Media info and actions
              Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: theme.colorScheme.surface,
                  borderRadius: const BorderRadius.vertical(
                    bottom: Radius.circular(16),
                  ),
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    // Description
                    Text(
                      mediaDescription,
                      style: theme.textTheme.titleMedium?.copyWith(
                        fontWeight: FontWeight.bold,
                      ),
                    ),

                    if (mediaCaption != null && mediaCaption.isNotEmpty) ...[
                      const SizedBox(height: 8),
                      Text(
                        mediaCaption,
                        style: theme.textTheme.bodyMedium?.copyWith(
                          color: theme.colorScheme.onSurface.withOpacity(0.8),
                        ),
                      ),
                    ],

                    const SizedBox(height: 16),

                    // Action buttons
                    Row(
                      mainAxisAlignment: MainAxisAlignment.end,
                      children: [
                        TextButton(
                          onPressed: () => Navigator.of(context).pop(),
                          child: const Text('Close'),
                        ),
                        if (mediaId != null)
                          ElevatedButton.icon(
                            onPressed: () {
                              Navigator.of(context).pop();
                              _deleteMedia(mediaId);
                            },
                            icon: const Icon(Icons.delete),
                            label: const Text('Delete'),
                            style: ElevatedButton.styleFrom(
                              backgroundColor: theme.colorScheme.error,
                              foregroundColor: theme.colorScheme.onError,
                            ),
                          ),
                      ],
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Future<void> _handleAvailableStatusChange(bool isAvailable) async {
    try {
// REMOVED:       if (widget.profile == 'employee') {
// REMOVED:         await EmployeeService.updateEmployeeAvailableStatus(
          isAvailable: isAvailable,
        );

        // Update local employee profile data
        if (_employeeProfileData != null) {
          setState(() {
            _employeeProfileData!['is_available'] = isAvailable;
          });
        }
      } else if (widget.profile == 'business' && widget.userData != null) {
        final businessId = widget.userData!['id'];
        await BusinessService.updateBusinessAvailableStatus(
          businessId: businessId,
          isAvailable: isAvailable,
        );

        // Update local business profile data
        setState(() {
          widget.userData!['is_available'] = isAvailable;
        });
// REMOVED:       } else if (widget.profile == 'professional') {
// REMOVED:         await ProfessionalService.updateProfessionalAvailableStatus(
          isAvailable: isAvailable,
        );

        // Update local professional profile data
        if (_professionalProfileData != null) {
          setState(() {
            _professionalProfileData!['is_available'] = isAvailable;
          });
        }
      }

      // Show success message
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(
              isAvailable
                  ? 'Profile set to available successfully'
                  : 'Profile set to unavailable successfully',
            ),
            backgroundColor: Colors.green,
          ),
        );
      }
    } catch (e) {
      // Show error message
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Failed to update profile availability: $e'),
            backgroundColor: Colors.red,
          ),
        );
      }
    }
  }

  /// Show job offer details in a bottom sheet
  void _showJobOfferDetails(Map<String, dynamic> offering) {
    final theme = Theme.of(context);
    final otherParty = offering['other_party'] as Map<String, dynamic>? ?? {};
    final jobVacancyDetails =
        offering['job_vacancy_details'] as Map<String, dynamic>? ?? {};
    final isAccepted = offering['is_accepted'] as bool? ?? false;
    final offeringType = offering['offering_type'] as String? ?? '';
    final createdAt = offering['created_at'] as int? ?? 0;
    final offeringId = offering['id'] as String? ?? '';

    // Format timestamps
    final offerDate = createdAt > 0
        ? _formatDate(DateTime.fromMillisecondsSinceEpoch(createdAt * 1000))
        : 'Not specified';

    final lastDateToApply =
        jobVacancyDetails['last_date_to_apply'] as int? ?? 0;
    final formattedLastDate = lastDateToApply > 0
        ? _formatDate(
            DateTime.fromMillisecondsSinceEpoch(lastDateToApply * 1000),
          )
        : 'Not specified';

    // Format salary range
    final minSalary = jobVacancyDetails['min_salary'] as int? ?? 0;
    final maxSalary = jobVacancyDetails['max_salary'] as int? ?? 0;
    final salaryRange = minSalary > 0 && maxSalary > 0
        ? '‚Çπ${minSalary.toString().replaceAllMapped(RegExp(r'(\d{1,3})(?=(\d{3})+(?!\d))'), (Match m) => '${m[1]},')} - ‚Çπ${maxSalary.toString().replaceAllMapped(RegExp(r'(\d{1,3})(?=(\d{3})+(?!\d))'), (Match m) => '${m[1]},')}'
        : 'Salary not specified';

    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => DraggableScrollableSheet(
        initialChildSize: 0.7,
        maxChildSize: 0.9,
        minChildSize: 0.5,
        builder: (context, scrollController) => Container(
          decoration: BoxDecoration(
            color: theme.colorScheme.surface,
            borderRadius: const BorderRadius.vertical(top: Radius.circular(20)),
          ),
          child: Column(
            children: [
              // Handle bar
              Container(
                margin: const EdgeInsets.symmetric(vertical: 12),
                width: 40,
                height: 4,
                decoration: BoxDecoration(
                  color: theme.colorScheme.onSurface.withOpacity(0.3),
                  borderRadius: BorderRadius.circular(2),
                ),
              ),
              // Content
              Expanded(
                child: SingleChildScrollView(
                  controller: scrollController,
                  padding: const EdgeInsets.all(24),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      // Header
                      Row(
                        children: [
                          Container(
                            width: 60,
                            height: 60,
                            decoration: BoxDecoration(
                              color: theme.colorScheme.primaryContainer,
                              borderRadius: BorderRadius.circular(8),
                            ),
                            child: Icon(
                              Icons.business,
                              color: theme.colorScheme.onPrimaryContainer,
                              size: 30,
                            ),
                          ),
                          const SizedBox(width: 16),
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  jobVacancyDetails['job_title'] ?? 'Job Title',
                                  style: theme.textTheme.headlineSmall
                                      ?.copyWith(fontWeight: FontWeight.bold),
                                ),
                                Text(
                                  otherParty['name'] ?? 'Company Name',
                                  style: theme.textTheme.bodyMedium?.copyWith(
                                    color: theme.colorScheme.primary,
                                  ),
                                ),
                                Container(
                                  margin: const EdgeInsets.only(top: 8),
                                  padding: const EdgeInsets.symmetric(
                                    horizontal: 12,
                                    vertical: 4,
                                  ),
                                  decoration: BoxDecoration(
                                    color: isAccepted
                                        ? Colors.green
                                        : Colors.orange,
                                    borderRadius: BorderRadius.circular(16),
                                  ),
                                  child: Text(
                                    isAccepted ? 'Accepted' : 'Pending',
                                    style: const TextStyle(
                                      color: Colors.white,
                                      fontSize: 12,
                                      fontWeight: FontWeight.w500,
                                    ),
                                  ),
                                ),
                              ],
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 24),

                      // Job Details Section
                      _buildDetailSection('Job Details', [
                        _buildDetailRow(
                          'Position',
                          jobVacancyDetails['job_title'] ?? 'Not specified',
                        ),
                        _buildDetailRow(
                          'Description',
                          jobVacancyDetails['job_description'] ??
                              'No description provided',
                        ),
                        _buildDetailRow(
                          'Location',
                          jobVacancyDetails['job_location'] ?? 'Not specified',
                        ),
                        _buildDetailRow(
                          'Type',
                          _formatJobType(jobVacancyDetails['job_type'] ?? ''),
                        ),
                        _buildDetailRow('Salary Range', salaryRange),
                        _buildDetailRow(
                          'Last Date to Apply',
                          formattedLastDate,
                        ),
                      ]),

                      const SizedBox(height: 20),

                      // Company Details Section
                      _buildDetailSection('Company Details', [
                        _buildDetailRow(
                          'Company Name',
                          otherParty['name'] ?? 'Not specified',
                        ),
                        _buildDetailRow(
                          'Username',
                          '@${otherParty['username'] ?? 'unknown'}',
                        ),
                      ]),

                      const SizedBox(height: 20),

                      // Offer Details Section
                      _buildDetailSection('Offer Information', [
                        _buildDetailRow('Offer Date', offerDate),
                        _buildDetailRow('Offer ID', offeringId),
                        _buildDetailRow('Offer Type', offeringType),
                        _buildDetailRow(
                          'Status',
                          isAccepted ? 'Accepted' : 'Pending Response',
                        ),
                      ]),

                      const SizedBox(height: 32),

                      // Action Buttons
                      Row(
                        children: [
                          Expanded(
                            child: OutlinedButton(
                              onPressed: () => Navigator.pop(context),
                              child: const Text('Close'),
                            ),
                          ),
                          if (!isAccepted) ...[
                            const SizedBox(width: 16),
                            Expanded(
                              child: ElevatedButton(
                                onPressed: () {
                                  Navigator.pop(context);
                                  _acceptJobOffer(offering);
                                },
                                child: const Text('Accept Offer'),
                              ),
                            ),
                          ],
                        ],
                      ),
                    ],
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  /// Open chat with business
  void _openChatWithBusiness(Map<String, dynamic> offering) {
    final otherParty = offering['other_party'] as Map<String, dynamic>? ?? {};
    final businessId = otherParty['id'] as String?;
    final businessName = otherParty['name'] as String?;
    final businessImage = otherParty['img_url'] as String?;

    if (businessId == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Unable to start chat: Business ID not found'),
          backgroundColor: Colors.red,
        ),
      );
      return;
    }

    // Get employee ID (sender ID) - we need to fetch this from the current user's profile
    String? employeeId;
    if (_employeeProfileData != null) {
      employeeId = _employeeProfileData!['id'] as String?;
    }

    if (employeeId == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Unable to start chat: Employee ID not found'),
          backgroundColor: Colors.red,
        ),
      );
      return;
    }

    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => ChatScreen(
          userId: businessId,
          senderId: employeeId!,
          receiverId: businessId,
          contactName: businessName ?? 'Business',
          contactImage: businessImage,
        ),
      ),
    );
  }

  /// Open chat with employee
  void _openChatWithEmployee(Map<String, dynamic> invite) {
    final employeeDetails =
        invite['employee_details'] as Map<String, dynamic>? ?? {};
    final employeeId = employeeDetails['id'] as String?;
    final employeeName =
        '${employeeDetails['first_name'] ?? ''} ${employeeDetails['last_name'] ?? ''}'
            .trim();
    final employeeImage = employeeDetails['img_url'] as String?;

    if (employeeId == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Unable to start chat: Employee ID not found'),
          backgroundColor: Colors.red,
        ),
      );
      return;
    }

    // Get business ID (sender ID) from widget.userData
    final businessId = widget.userData?['id'] as String?;
    if (businessId == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Unable to start chat: Business ID not found'),
          backgroundColor: Colors.red,
        ),
      );
      return;
    }

    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => ChatScreen(
          userId: employeeId,
          senderId: businessId,
          receiverId: employeeId,
          contactName: employeeName.isNotEmpty ? employeeName : 'Employee',
          contactImage: employeeImage,
        ),
      ),
    );
  }

  /// Accept a job offer
  Future<void> _acceptJobOffer(Map<String, dynamic> offering) async {
    final offeringId = offering['id'] as String?;
    if (offeringId == null) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('Invalid offer ID'),
            backgroundColor: Colors.red,
          ),
        );
      }
      return;
    }

    // Show loading dialog
    if (mounted) {
      showDialog(
        context: context,
        barrierDismissible: false,
        builder: (context) => Dialog(
          child: IntrinsicHeight(
            child: Padding(
              padding: const EdgeInsets.all(24),
              child: Column(
                children: [
                  const CircularProgressIndicator(),
                  const SizedBox(height: 16),
                  Expanded(
                    child: Text(
                      'Accepting job offer...',
                      style: Theme.of(context).textTheme.bodyMedium,
                      overflow: TextOverflow.ellipsis,
                      maxLines: 2,
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),
      );
    }

    try {
      final response = await ApiService.put(
        '/accept-employee-joboffering/',
        body: {'offering_id': offeringId},
        useBearerToken: true,
      );

      if (mounted) {
        Navigator.of(context).pop(); // Close loading dialog
      }

      if (response['data'] != null && response['data']['status'] == 200) {
        // Success
        final message =
            response['data']['message'] ?? 'Job offering accepted successfully';

        // Update the local data
        setState(() {
          offering['is_accepted'] = true;
        });

        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(content: Text(message), backgroundColor: Colors.green),
          );
        }

        // Refresh the job offerings list
        _fetchEmployeeJobOfferings();
      } else {
        // Handle error response
        final errorMessage =
            response['data']?['message'] ?? 'Failed to accept job offer';
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(content: Text(errorMessage), backgroundColor: Colors.red),
          );
        }
      }
    } catch (e) {
      if (mounted) {
        Navigator.of(context).pop(); // Close loading dialog
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Error accepting job offer: $e'),
            backgroundColor: Colors.red,
          ),
        );
      }
    }
  }

  /// Get current CPC value from profile data based on profile type
  int? _getCurrentCpc() {
    switch (widget.profile) {
      case 'professional':
        final cpc = _professionalProfileData?['cpc'];
        if (cpc != null) {
          if (cpc is int) return cpc;
          if (cpc is double) return cpc.toInt();
          if (cpc is String) return int.tryParse(cpc);
        }
        return null;
      case 'business':
        final cpc = widget.userData?['cpc'];
        if (cpc != null) {
          if (cpc is int) return cpc;
          if (cpc is double) return cpc.toInt();
          if (cpc is String) return int.tryParse(cpc);
        }
        return null;
      case 'employee':
        final cpc = _employeeProfileData?['cpc'];
        if (cpc != null) {
          if (cpc is int) return cpc;
          if (cpc is double) return cpc.toInt();
          if (cpc is String) return int.tryParse(cpc);
        }
        return null;
      default:
        return null;
    }
  }
}

// Extension to capitalize first letter of a string
extension StringExtension on String {
  String capitalize() {
    return "${this[0].toUpperCase()}${substring(1)}";
  }
}
